---
phase: 07-gee-documentation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vignettes/gee-workflow.Rmd
  - _pkgdown.yml
  - R/get_marginal_effect.R
  - R/estimate_varcov.R
  - NEWS.md
autonomous: true

must_haves:
  truths:
    - "A user searching for GEE support finds the gee-workflow vignette via pkgdown navigation"
    - "The vignette runs a complete glmgee example: data setup, model fitting, get_marginal_effect, result interpretation"
    - "help(get_marginal_effect) lists glmgee and geeglm as accepted object types"
    - "help(estimate_varcov) documents which variance types are valid for GLM vs glmgee vs geeglm"
    - "NEWS.md shows v0.4.0 with GEE support as the primary new feature"
  artifacts:
    - path: "vignettes/gee-workflow.Rmd"
      provides: "End-to-end GEE workflow vignette"
      contains: "glmgee"
    - path: "_pkgdown.yml"
      provides: "Website navigation including GEE vignette"
      contains: "gee-workflow"
    - path: "R/get_marginal_effect.R"
      provides: "Updated roxygen listing GEE object types"
      contains: "glmgee"
    - path: "R/estimate_varcov.R"
      provides: "Updated roxygen with GEE variance type documentation"
      contains: "bias-corrected"
    - path: "NEWS.md"
      provides: "v0.4.0 release notes"
      contains: "beeca 0.4.0"
  key_links:
    - from: "_pkgdown.yml"
      to: "vignettes/gee-workflow.Rmd"
      via: "articles section"
      pattern: "gee-workflow"
    - from: "R/get_marginal_effect.R"
      to: "R/estimate_varcov.R"
      via: "consistent GEE object documentation"
      pattern: "glmgee.*geeglm"
---

<objective>
Complete GEE documentation for beeca v0.4.0: create a GEE workflow vignette, update roxygen man pages to document GEE object support and variance types, add v0.4.0 release notes to NEWS.md, and register the vignette in pkgdown.

Purpose: Users can discover, understand, and use beeca's GEE support through standard R documentation channels (vignettes, help pages, NEWS).
Output: vignettes/gee-workflow.Rmd, updated roxygen in R/get_marginal_effect.R and R/estimate_varcov.R, updated NEWS.md and _pkgdown.yml
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-gee-documentation/07-RESEARCH.md
@.planning/phases/05-gee-core-implementation/05-02-SUMMARY.md
@.planning/phases/06-gee-testing/06-01-SUMMARY.md
@vignettes/clinical-trial-table.Rmd
@R/get_marginal_effect.R
@R/estimate_varcov.R
@R/sanitize.R
@NEWS.md
@_pkgdown.yml
@DESCRIPTION
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GEE workflow vignette</name>
  <files>vignettes/gee-workflow.Rmd, _pkgdown.yml</files>
  <action>
Create `vignettes/gee-workflow.Rmd` following the exact structure of `clinical-trial-table.Rmd`.

**YAML header:**
```yaml
---
title: "Using GEE Models with beeca"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using GEE Models with beeca}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```

**Setup chunk** (hidden, include = FALSE):
```r
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5
)
```

**Vignette sections (follow this outline):**

1. **Overview** -- 2-3 sentences. Start with the USER'S problem, not GEE theory. "If your trial uses cluster randomization or has within-subject correlation structure, GEE models may be more appropriate than standard GLM. beeca now supports GEE objects from the glmtoolbox and geepack packages, allowing covariate-adjusted marginal treatment effect estimation using the same g-computation pipeline." List what the vignette covers: setup, fitting a GEE model, estimating treatment effects, interpreting results, comparing variance types.

2. **Setup** -- Load beeca and dplyr (always). Load glmtoolbox with `eval=requireNamespace("glmtoolbox", quietly = TRUE)` guard. Note that glmtoolbox and geepack are suggested packages: install with `install.packages("glmtoolbox")` or `install.packages("geepack")`.

3. **Example Data** -- Use beeca's `trial01` dataset. Prepare it: `trial01$trtp <- factor(trial01$trtp)`. Add a cluster ID column: `trial01$site_id <- 1:nrow(trial01)` (since beeca's GEE support requires single-timepoint data with one observation per cluster, each subject IS its own cluster). Briefly explain: "For single-timepoint data, each subject forms its own cluster. In practice, your data would have a natural clustering variable (e.g., study site, clinic)."

4. **Fitting a GEE Model with glmtoolbox** -- All code chunks in this section use `eval=requireNamespace("glmtoolbox", quietly = TRUE)`. Show:
   ```r
   library(glmtoolbox)
   fit_gee <- glmgee(
     aval ~ trtp + bl_cov,
     id = site_id,
     family = binomial(link = "logit"),
     corstr = "independence",
     data = trial01
   )
   ```
   Brief explanation: corstr = "independence" is appropriate for single-timepoint data. Mention that other correlation structures (exchangeable, AR(1)) would be relevant for repeated measures, but beeca currently supports single-timepoint only.

5. **Estimating the Marginal Treatment Effect** -- Show get_marginal_effect call:
   ```r
   result <- get_marginal_effect(
     fit_gee,
     trt = "trtp",
     method = "Ge",
     contrast = "diff",
     reference = "0"
   )
   result$marginal_results
   ```
   Note: Only `method = "Ge"` is supported for GEE objects. Ye's method assumes independence and is not applicable. The default variance type is "robust".

6. **Interpreting Results** -- Show `result$marginal_est` and `result$marginal_se`. Explain: "The risk difference, standard error, and ARD tibble follow the same structure as standard GLM results. The key difference is that variance estimation uses GEE's robust sandwich estimator via the delta method (Ge et al., 2011) instead of sandwich::vcovHC."

7. **Variance Types for GEE** -- Show the three variance types available for glmgee:
   ```r
   # Default: robust sandwich estimator
   result_robust <- get_marginal_effect(fit_gee, trt = "trtp", method = "Ge",
                                         type = "robust", contrast = "diff", reference = "0")

   # Bias-corrected (Mancl-DeRouen)
   result_bc <- get_marginal_effect(fit_gee, trt = "trtp", method = "Ge",
                                     type = "bias-corrected", contrast = "diff", reference = "0")

   # Degrees-of-freedom adjusted
   result_df <- get_marginal_effect(fit_gee, trt = "trtp", method = "Ge",
                                     type = "df-adjusted", contrast = "diff", reference = "0")
   ```
   Create a comparison data.frame showing the SEs from each type. Note: for geeglm objects, only "robust" is available.

8. **Using geepack** -- Show the equivalent workflow with geepack/geeglm. Use `eval=requireNamespace("geepack", quietly = TRUE)` guard:
   ```r
   library(geepack)
   fit_geeglm <- geeglm(
     aval ~ trtp + bl_cov,
     id = site_id,
     family = binomial(link = "logit"),
     corstr = "independence",
     data = trial01
   )
   result_geeglm <- get_marginal_effect(
     fit_geeglm,
     trt = "trtp",
     method = "Ge",
     contrast = "diff",
     reference = "0"
   )
   result_geeglm$marginal_results
   ```

9. **Key Differences from Standard GLM** -- Brief bullet list:
   - Only Ge et al. method supported (not Ye et al.)
   - Variance types differ: "robust", "bias-corrected", "df-adjusted" (glmgee) or "robust" only (geeglm) instead of HC0/HC1/.../HC5
   - Single-timepoint data only (one observation per cluster)
   - Point estimates (marginal treatment effects) are identical to what standard GLM would produce for single-timepoint independence structure

10. **Next steps** -- Cross-reference: `vignette('estimand_and_implementations')` for estimand concepts, `vignette('clinical-trial-table')` for creating publication tables.

11. **References** -- Ge et al. (2011) with DOI, Ye et al. (2023) with DOI for context on why it's excluded, Magirr et al. (2025) with DOI.

**Update `_pkgdown.yml`:** Add `gee-workflow` to the articles section under a new "GEE Extension" title:
```yaml
- title: GEE Extension
  navbar: GEE Extension
  contents:
  - gee-workflow
```
Place this after the existing "Applications" section.
  </action>
  <verify>
Run `Rscript -e "rmarkdown::render('vignettes/gee-workflow.Rmd', output_dir = tempdir())"` to confirm the vignette builds without errors. Verify `_pkgdown.yml` is valid YAML with `Rscript -e "yaml::read_yaml('_pkgdown.yml')"`.
  </verify>
  <done>
vignettes/gee-workflow.Rmd exists, builds without error, contains sections for Overview, Setup, Example Data, glmtoolbox workflow, geepack workflow, variance types, key differences, and references. _pkgdown.yml includes gee-workflow in articles section. (DOC-01)
  </done>
</task>

<task type="auto">
  <name>Task 2: Update roxygen man pages and NEWS.md</name>
  <files>R/get_marginal_effect.R, R/estimate_varcov.R, NEWS.md</files>
  <action>
**1. Update `R/get_marginal_effect.R` roxygen:**

Change the `@param object` line from:
```r
#' @param object a fitted \link[stats]{glm} object.
```
to:
```r
#' @param object a fitted model object. Supported types:
#'   \itemize{
#'     \item \code{\link[stats]{glm}} with binomial family and logit link
#'     \item \code{glmgee} from \code{\link[glmtoolbox]{glmgee}} (requires \pkg{glmtoolbox})
#'     \item \code{geeglm} from \code{\link[geepack]{geeglm}} (requires \pkg{geepack})
#'   }
#'   For GEE objects, only single-timepoint data (one observation per cluster)
#'   is currently supported.
```

Update `@description` to mention GEE: change "Estimates the marginal treatment effect from a logistic regression working model" to "Estimates the marginal treatment effect from a logistic regression working model or GEE model".

Update `@details` to add a GEE paragraph at the end:
```r
#' For GEE objects (\code{glmgee} or \code{geeglm}), only the Ge et al. (2011)
#' method is supported. Ye's method assumes independence and is not valid for
#' GEE. The default variance type for GEE is "robust". See
#' \code{\link{estimate_varcov}} for available GEE variance types.
```

Update `@param type` to add GEE info after the existing text:
```r
#' @param type a string indicating the type of variance estimator to use
#' (only applicable for Ge's method). For \code{glm} objects: supported types
#' include HC0 (default), model-based, HC3, HC, HC1, HC2, HC4, HC4m, and HC5.
#' See \link[sandwich]{vcovHC} for heteroscedasticity-consistent estimators.
#' For \code{glmgee} objects: supported types are "robust" (default),
#' "bias-corrected", and "df-adjusted".
#' For \code{geeglm} objects: only "robust" is supported.
```

Update `@param method` to add the GEE note:
```r
#' @param method a string indicating the chosen method for variance estimation.
#' Supported methods are `Ge` and `Ye`. The default method is `Ge` based on Ge
#' et al (2011) which is suitable for the variance estimation of conditional
#' average treatment effect. The method `Ye` is based on Ye et al (2023) and is
#' suitable for the variance estimation of population average treatment effect.
#' For more details, see Magirr et al. (2025) \doi{10.1002/pst.70021}.
#' Note: For GEE objects, only `Ge` is supported.
```

Update `@return` to mention GEE: change "an updated `glm` object" to "an updated model object (of the same class as the input)".

Add a GEE example in \donttest{} block AFTER the existing example:
```r
#' \donttest{
#' # GEE example (requires glmtoolbox)
#' if (requireNamespace("glmtoolbox", quietly = TRUE)) {
#'   library(glmtoolbox)
#'   trial01$trtp <- factor(trial01$trtp)
#'   trial01$id <- seq_len(nrow(trial01))
#'   fit_gee <- glmgee(aval ~ trtp + bl_cov, id = id,
#'                      family = binomial(link = "logit"),
#'                      corstr = "independence", data = trial01)
#'   result <- get_marginal_effect(fit_gee, trt = "trtp",
#'                                  method = "Ge", contrast = "diff",
#'                                  reference = "0")
#'   result$marginal_results
#' }
#' }
```

**2. Update `R/estimate_varcov.R` roxygen:**

Change `@description` from "Main variance estimation function. Estimates the variance-covariance matrix of a marginal estimand for a generalized linear model (GLM) object" to "Main variance estimation function. Estimates the variance-covariance matrix of a marginal estimand for a GLM or GEE model object".

Change `@param object` from:
```r
#' @param object a fitted \code{\link[stats]{glm}} object augmented with
#' `counterfactual.predictions`, `counterfactual.predictions` and `counterfactual.means`
```
to:
```r
#' @param object a fitted model object (\code{\link[stats]{glm}}, \code{glmgee},
#' or \code{geeglm}) augmented with `counterfactual.predictions` and
#' `counterfactual.means` from prior pipeline steps.
```

Replace the entire `@param type` block with:
```r
#' @param type a string indicating the type of variance estimator to use
#'   (only applicable for Ge's method). Supported types depend on the model class:
#'
#'   For \code{glm} objects:
#'   \itemize{
#'     \item HC0 (default) - Heteroscedasticity-consistent (White's estimator)
#'     \item model-based - Model-based variance
#'     \item HC1, HC2, HC3, HC4, HC4m, HC5 - Alternative HC estimators
#'   }
#'   See \link[sandwich]{vcovHC} for details.
#'
#'   For \code{glmgee} objects:
#'   \itemize{
#'     \item "robust" (default) - Robust sandwich estimator
#'     \item "bias-corrected" - Bias-corrected sandwich estimator (Mancl-DeRouen)
#'     \item "df-adjusted" - Degrees-of-freedom adjusted estimator
#'   }
#'
#'   For \code{geeglm} objects:
#'   \itemize{
#'     \item "robust" (only option) - Robust sandwich estimator
#'   }
#'
#'   Passing a GLM-style type (e.g., "HC0") to a GEE object will produce an
#'   informative error listing valid GEE types.
```

Add a GEE note to `@param method`:
```r
#' Note: For GEE objects, only `Ge` is supported. Ye's method assumes
#' independence and is not valid for GEE models.
```

Update `@details` to add GEE paragraph at the end:
```r
#' For GEE objects, variance estimation uses the delta method with GEE's
#' robust sandwich estimator obtained via \code{vcov()}. This replaces the
#' \code{sandwich::vcovHC} approach used for standard GLM objects. See
#' Ge et al. (2011) for the delta method methodology.
```

Update `@return` to mention GEE: change "an updated `glm` object" to "an updated model object (of the same class as the input)".

**3. Update `NEWS.md`:**

Prepend a v0.4.0 section BEFORE the existing v0.3.0 section. Use the exact format from research (Pattern 6), with bullets using * (not -):

```markdown
# beeca 0.4.0

## New Features

* **GEE support**: `get_marginal_effect()` now accepts GEE objects from
  `{glmtoolbox}` (`glmgee`) and `{geepack}` (`geeglm`) for covariate-adjusted
  analysis of single-timepoint binary endpoint trials. Only the Ge et al. (2011)
  variance method is supported for GEE; the Ye et al. (2023) method assumes
  independence and is not applicable.

* `sanitize_model.glmgee()` and `sanitize_model.geeglm()`: New S3 methods
  validate GEE objects, ensuring binomial family, logit link, and
  single-timepoint data (one observation per cluster).

* GEE variance estimation uses the delta method with GEE's robust sandwich
  estimator via `vcov()`. For `glmgee` objects, supported variance types are
  "robust" (default), "bias-corrected", and "df-adjusted". For `geeglm`
  objects, only "robust" is supported.

## Documentation

* New vignette: "Using GEE Models with beeca" demonstrates end-to-end workflow
  for GEE model analysis including variance type comparison.

* Updated `get_marginal_effect()` and `estimate_varcov()` documentation to list
  supported model classes (`glm`, `glmgee`, `geeglm`) and GEE-specific variance
  types.
```

Then keep all existing content (# beeca 0.3.0 etc.) below.

**4. Regenerate documentation:**

Run `Rscript -e "devtools::document()"` to rebuild man pages from updated roxygen.
  </action>
  <verify>
Run `Rscript -e "devtools::document()"` -- should complete without errors. Run `Rscript -e "devtools::check(document = FALSE, args = c('--no-tests', '--no-vignettes'))"` to confirm no roxygen-related warnings. Verify NEWS.md starts with "# beeca 0.4.0". Verify `man/get_marginal_effect.Rd` contains "glmgee" and `man/estimate_varcov.Rd` contains "bias-corrected".
  </verify>
  <done>
get_marginal_effect roxygen documents glmgee, geeglm as accepted object types with GEE-specific notes. estimate_varcov roxygen documents all three GEE variance types (robust, bias-corrected, df-adjusted) with per-class details. NEWS.md has v0.4.0 section at top with GEE features. Man pages regenerated. (DOC-02, DOC-03)
  </done>
</task>

</tasks>

<verification>
1. `Rscript -e "rmarkdown::render('vignettes/gee-workflow.Rmd', output_dir = tempdir())"` -- vignette builds
2. `Rscript -e "devtools::document()"` -- man pages regenerate
3. `Rscript -e "devtools::check(args = c('--no-tests'))"` -- 0 errors, 0 warnings
4. Grep for "glmgee" in man/get_marginal_effect.Rd -- found
5. Grep for "bias-corrected" in man/estimate_varcov.Rd -- found
6. Grep for "gee-workflow" in _pkgdown.yml -- found
7. NEWS.md first line contains "beeca 0.4.0"
</verification>

<success_criteria>
- vignettes/gee-workflow.Rmd exists and builds without error, showing complete glmgee and geeglm workflows with eval guards
- _pkgdown.yml articles section includes gee-workflow
- help(get_marginal_effect) lists glmgee and geeglm as supported object types
- help(estimate_varcov) documents robust/bias-corrected/df-adjusted for glmgee and robust for geeglm
- NEWS.md has v0.4.0 section with GEE support as primary new feature
- R CMD check passes with 0 errors, 0 warnings (notes acceptable)
- Requirements DOC-01, DOC-02, DOC-03 all satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/07-gee-documentation/07-01-SUMMARY.md`
</output>
