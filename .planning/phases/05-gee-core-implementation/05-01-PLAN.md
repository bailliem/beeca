---
phase: 05-gee-core-implementation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - R/sanitize.R
  - DESCRIPTION
autonomous: true

must_haves:
  truths:
    - "A glmgee object passes sanitize_model validation with binomial/logit family and factor treatment"
    - "A geeglm object passes sanitize_model validation with binomial/logit family and factor treatment"
    - "Invalid GEE objects (wrong family, non-factor treatment, interactions) produce clear error messages mentioning the GEE class name"
    - "Multi-timepoint GEE data (cluster size > 1) is rejected with informative error"
    - "Missing GEE package produces install hint error"
  artifacts:
    - path: "R/sanitize.R"
      provides: "sanitize_model.glmgee and sanitize_model.geeglm S3 methods"
      contains: "sanitize_model.glmgee"
    - path: "R/sanitize.R"
      provides: "sanitize_model.geeglm S3 method"
      contains: "sanitize_model.geeglm"
    - path: "DESCRIPTION"
      provides: "glmtoolbox and geepack in Suggests"
      contains: "glmtoolbox"
  key_links:
    - from: "R/sanitize.R"
      to: "sanitize_variable"
      via: "reuse existing helper for treatment variable checks"
      pattern: "sanitize_variable\\(model, trt\\)"
    - from: "R/sanitize.R"
      to: "requireNamespace"
      via: "early package availability check"
      pattern: "requireNamespace.*quietly"
---

<objective>
Add S3 validation methods for GEE objects (glmgee and geeglm) to beeca's sanitize_model generic, plus update DESCRIPTION to declare GEE packages in Suggests.

Purpose: This is the gate -- GEE objects currently fail at sanitize_model with "class not supported". Once validation passes, predict_counterfactuals and average_predictions will work immediately because both GEE packages provide GLM-compatible predict() methods.

Output: Two new S3 methods in R/sanitize.R, updated DESCRIPTION with glmtoolbox/geepack in Suggests.
</objective>

<execution_context>
@./.claude/agents/gsd-executor.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-gee-core-implementation/05-CONTEXT.md
@.planning/phases/05-gee-core-implementation/05-RESEARCH.md
@R/sanitize.R
@DESCRIPTION
@NAMESPACE
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add glmtoolbox and geepack to DESCRIPTION Suggests</name>
  <files>DESCRIPTION</files>
  <action>
Add glmtoolbox and geepack to the Suggests field in DESCRIPTION. Pin minimum versions based on the API features needed:
- glmtoolbox (>= 0.1.12) -- needed for vcov type options and stable predict.glmgee
- geepack (>= 1.3.13) -- needed for stable geeglm API

Add them alphabetically within the existing Suggests list. Keep formatting consistent with existing entries (4-space indent, trailing comma except last).
  </action>
  <verify>Run `Rscript -e "desc <- read.dcf('DESCRIPTION'); cat(desc[,'Suggests'])"` to confirm both packages appear in Suggests with version constraints.</verify>
  <done>DESCRIPTION contains glmtoolbox (>= 0.1.12) and geepack (>= 1.3.13) in Suggests field.</done>
</task>

<task type="auto">
  <name>Task 2: Implement sanitize_model.glmgee and sanitize_model.geeglm S3 methods</name>
  <files>R/sanitize.R</files>
  <action>
Add two new S3 methods to R/sanitize.R. Both follow the existing sanitize_model.glm pattern (collect reasons_stop/reasons_warn, report errors at end). Key implementation details:

**sanitize_model.glmgee:**

1. Package availability check FIRST (fail fast per user decision):
   ```r
   if (!requireNamespace("glmtoolbox", quietly = TRUE)) {
     stop('glmtoolbox is required for glmgee objects. Install with install.packages("glmtoolbox")', call. = FALSE)
   }
   ```

2. Reuse sanitize_variable(model, trt) -- this helper checks treatment is on RHS, is factor with 2+ levels, and response is 0/1. It accesses model$terms and .get_data(model), both of which work for glmgee (confirmed in feasibility testing -- glmgee has $model slot).

3. Family/link check: same as GLM -- `model$family$family != "binomial" | model$family$link != "logit"`. Error should say "Model of class glmgee ..." per user decision to include class name.

4. Interaction check: same as GLM -- check attr(model$terms, "order") > 1 and treatment in interaction terms.

5. Single-timepoint validation (GEE-specific, per user decision):
   - Extract cluster IDs. For glmgee, inspect the object to find how the id variable is stored. Try `model$id` first; if that does not contain cluster identifiers, check `model$call$id` and evaluate it against the model data. The feasibility test used `id = id` in the glmgee() call.
   - Count observations per cluster using table().
   - If any cluster has > 1 observation: stop with "Multi-timepoint data detected: [N] clusters have more than 1 observation. beeca currently supports single-timepoint GEE models only."

6. Full rank check: Try the GLM approach `ncol(model.matrix(model)) != model$qr$rank`. If glmgee does NOT have a $qr component, skip this check (GEE fitting uses different internals). Do NOT error -- just skip gracefully.

7. Convergence check: Try `model$converged`. The feasibility test showed glmgee retains `$converged`. If present and FALSE, add to reasons_warn.

8. Missing data check: Same approach as GLM if applicable -- compare nrow(model$data) vs nrow(model.frame(model)). If glmgee object does not have $data, skip this check.

9. Error reporting pattern -- match GLM exactly:
   ```r
   if (!is.null(reasons_stop)) {
     msg_stop <- sapply(reasons_stop, function(x) c(sprintf("Model of class glmgee %s is not supported.", x), "\n"))
     stop(msg_stop, call. = FALSE)
   }
   ```

10. Set `model$sanitized <- TRUE` and return.

**sanitize_model.geeglm:**

Same structure as glmgee with these differences:

1. Package check: `requireNamespace("geepack", ...)` with install hint for geepack.

2. Cluster ID extraction: geeglm stores cluster IDs in `model$id`. Verify this is accessible and use it for single-timepoint validation.

3. Convergence: geeglm REMOVES `$converged` attribute (per research -- "toDelete includes converged"). Do NOT check convergence for geeglm. Skip this check entirely -- add a code comment explaining why.

4. Full rank: geeglm likely does not have $qr. Skip rank check if $qr is NULL.

5. Error messages say "Model of class geeglm ..." (not glmgee).

6. .get_data() already works for geeglm (confirmed in feasibility -- geeglm has $model slot).

**Also update sanitize_model.default:**

The current default method checks `!inherits(model, "glm")`. Since glmgee inherits from glm, it would currently fall through to default rather than erroring. With the new S3 methods, this is handled by dispatch. No change needed to default -- but verify that R's S3 dispatch will find sanitize_model.glmgee before sanitize_model.glm (it will, because S3 dispatch uses the first class in the class vector).

**Add roxygen2 exports for the new S3 methods:**

Add `@export` tags to both methods so they appear in NAMESPACE as:
```
S3method(sanitize_model,glmgee)
S3method(sanitize_model,geeglm)
```

Follow the existing roxygen pattern from sanitize_model.glm. Add `@keywords internal` since these are internal validation functions.

**IMPORTANT implementation note about .get_data():**

.get_data() returns model$model. For GEE objects, the `model$model` slot should contain the model frame (confirmed in feasibility). If for some reason it doesn't work, an alternative is `model.frame(model)` -- but prefer the existing `.get_data()` approach for consistency.
  </action>
  <verify>
1. Run `Rscript -e "devtools::document('.')"` to generate NAMESPACE entries.
2. Verify NAMESPACE contains: `S3method(sanitize_model,glmgee)` and `S3method(sanitize_model,geeglm)`.
3. Run `Rscript -e "devtools::load_all('.'); library(glmtoolbox); library(geepack); set.seed(42); n <- 50; d <- data.frame(id=1:n, trtp=factor(rep(c('A','B'), each=n/2)), bl_cov=rnorm(n), aval=rbinom(n,1,0.5)); fit_gee <- glmgee(aval ~ trtp + bl_cov, id=id, family=binomial(logit), data=d, corstr='independence'); result <- sanitize_model(fit_gee, 'trtp'); cat('glmgee sanitized:', result[['sanitized']], '\n')"` to confirm glmgee validation works.
4. Run same test adapted for geeglm: `Rscript -e "devtools::load_all('.'); library(geepack); set.seed(42); n <- 50; d <- data.frame(id=1:n, trtp=factor(rep(c('A','B'), each=n/2)), bl_cov=rnorm(n), aval=rbinom(n,1,0.5)); fit_gee <- geeglm(aval ~ trtp + bl_cov, id=id, family=binomial(link='logit'), data=d, corstr='independence'); result <- sanitize_model(fit_gee, 'trtp'); cat('geeglm sanitized:', result[['sanitized']], '\n')"`.
5. Run existing test suite: `Rscript -e "devtools::test('.')"` -- all 308 existing tests must still pass (no regressions).
  </verify>
  <done>
- sanitize_model.glmgee validates glmgee objects (package check, family/link, treatment factor, interactions, single-timepoint, convergence)
- sanitize_model.geeglm validates geeglm objects (package check, family/link, treatment factor, interactions, single-timepoint)
- Error messages include GEE class name per user decision
- Multi-timepoint data rejected with informative error
- Missing package produces install hint
- Existing 308 GLM tests pass without modification
  </done>
</task>

</tasks>

<verification>
1. `Rscript -e "devtools::document('.')"` succeeds
2. NAMESPACE contains S3method entries for glmgee and geeglm
3. DESCRIPTION has glmtoolbox and geepack in Suggests
4. `Rscript -e "devtools::test('.')"` -- all existing tests pass
5. Manual smoke test: glmgee object passes through sanitize_model
6. Manual smoke test: geeglm object passes through sanitize_model
7. Manual smoke test: glmgee object passes through predict_counterfactuals (because sanitize passes, and predict works for GEE per feasibility)
</verification>

<success_criteria>
- sanitize_model(glmgee_object, "trtp") returns object with $sanitized == TRUE
- sanitize_model(geeglm_object, "trtp") returns object with $sanitized == TRUE
- predict_counterfactuals(glmgee_object, "trtp") produces counterfactual.predictions
- average_predictions works after predict_counterfactuals for GEE objects
- Invalid GEE objects produce clear error messages with class name
- All 308 existing tests pass (zero regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/05-gee-core-implementation/05-01-SUMMARY.md`
</output>
