---
phase: 03-vignette-review
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - vignettes/ard-cards-integration.Rmd
  - vignettes/clinical-trial-table.Rmd
autonomous: true

must_haves:
  truths:
    - "ARD vignette opens with a motivation scenario explaining why you need ARD integration"
    - "ARD vignette uses trial02_cdisc dataset instead of trial01"
    - "ARD vignette has no 'Future Enhancements' section"
    - "Clinical-trial-table vignette ends with a summary takeaway and cross-references"
    - "All three vignettes render without errors via devtools::build_vignettes()"
    - "All vignettes use consistent cross-reference syntax"
  artifacts:
    - path: "vignettes/ard-cards-integration.Rmd"
      provides: "Polished ARD vignette with motivation, trial02_cdisc, no future section"
      contains: "vignette.*estimand_and_implementations"
    - path: "vignettes/clinical-trial-table.Rmd"
      provides: "Polished clinical trial table vignette with summary takeaway"
      contains: "Summary"
  key_links:
    - from: "vignettes/ard-cards-integration.Rmd"
      to: "vignettes/estimand_and_implementations.Rmd"
      via: "cross-reference"
      pattern: "vignette.*estimand_and_implementations"
    - from: "vignettes/clinical-trial-table.Rmd"
      to: "vignettes/ard-cards-integration.Rmd"
      via: "cross-reference"
      pattern: "vignette.*ard-cards-integration"
---

<objective>
Polish the ARD/cards and clinical-trial-table vignettes, then verify all three vignettes render cleanly. ARD vignette gets motivation scenario, dataset switch to trial02_cdisc, and "Future Enhancements" removal. Clinical-trial-table gets summary takeaway and cross-references. Then build all vignettes to confirm zero rendering errors.

Purpose: Complete the progressive learning path (estimand -> clinical tables -> ARD integration) with coherent narrative, consistent datasets, and verified rendering for v0.3.0 release.

Output: Updated Rmd files for both vignettes, all three vignettes rendering without errors.
</objective>

<execution_context>
@./.claude/agents/gsd-executor.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-vignette-review/03-CONTEXT.md
@.planning/phases/03-vignette-review/03-RESEARCH.md
@.planning/phases/03-vignette-review/03-01-SUMMARY.md
@vignettes/ard-cards-integration.Rmd
@vignettes/clinical-trial-table.Rmd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Polish ARD/cards integration vignette</name>
  <files>vignettes/ard-cards-integration.Rmd</files>
  <action>
Edit vignettes/ard-cards-integration.Rmd with these changes:

**1. Add motivation scenario at the top (replace current Overview).**

Replace the current Overview section with a scenario-based opening:

The scenario: "You've run `get_marginal_effect()` and now need to create Table 14.2.1 for your Clinical Study Report. Your table requires baseline characteristics (from `cards::ard_continuous()`), treatment effects (from beeca), combined into a single ARD for your reporting pipeline."

Then briefly explain: "This vignette shows how beeca's ARD format integrates with the cards/cardx ecosystem for comprehensive clinical trial reporting."

Add a natural cross-reference: "This vignette assumes familiarity with beeca's marginal effect estimation. For methodology background, see `vignette('estimand_and_implementations')`."

Do NOT add explicit learning objectives or prerequisites boxes (locked decision).

**2. Switch from trial01 to trial02_cdisc.**

In the setup chunk, change:
```r
trial01$trtp <- factor(trial01$trtp)
fit1 <- glm(aval ~ trtp + bl_cov, family = "binomial", data = trial01) |>
  get_marginal_effect(trt = "trtp", method = "Ye", contrast = "diff", reference = "0")
```
to:
```r
dat <- trial02_cdisc |>
  dplyr::mutate(TRTP = factor(TRTP))
fit1 <- glm(AVAL ~ TRTP + SEX + RACE + AGE, family = binomial, data = dat) |>
  get_marginal_effect(trt = "TRTP", method = "Ye", contrast = "diff", reference = "Placebo")
```

Update ALL subsequent code chunks that reference trial01, bl_cov, trtp, aval to use trial02_cdisc equivalents (TRTP, AVAL, SEX, etc.). Key places to update:

- "Comprehensive Reporting" section: `cards::ard_continuous(data = trial01, by = trtp, variables = c(bl_cov))` -> use `dat` with appropriate CDISC variable names (by = TRTP, variables = AGE or similar continuous variable)
- "Quality Control Workflows" section: update `trial01` references to `dat`, update variable names
- "Cross-Study Meta-Analysis" section: update `trial01` references to `dat`, update variable names and formula
- "Example Usage" section: update `trial01` reference in `cards::ard_continuous()` call

**3. Remove "Future Enhancements" section entirely (locked decision).**

Delete the entire "## Future Enhancements" section (lines ~236-245 in current file). Release vignettes document what IS, not what MIGHT be added.

**4. Clean up references.**

Remove any package version numbers if present. Ensure the References section at the bottom has links to cards, cardx, CDISC, and beeca documentation (these already exist and are fine).

**5. Add cross-reference before Session Info.**

Before the "## Session Info" section, add:
```markdown
## Next Steps

- For estimand concepts and method selection, see `vignette('estimand_and_implementations')`
- For creating regulatory-ready tables, see `vignette('clinical-trial-table')`
```
  </action>
  <verify>
Read the file and confirm:
1. Opening has motivation scenario (not generic overview)
2. No references to trial01 anywhere in the file
3. No "Future Enhancements" section
4. Cross-references to both other vignettes present
5. Code chunks use trial02_cdisc variable names (TRTP, AVAL, SEX, RACE, AGE)
  </verify>
  <done>ARD vignette has motivation scenario, uses trial02_cdisc throughout, no future section, cross-references present</done>
</task>

<task type="auto">
  <name>Task 2: Polish clinical-trial-table vignette and add summary takeaway</name>
  <files>vignettes/clinical-trial-table.Rmd</files>
  <action>
Edit vignettes/clinical-trial-table.Rmd with these changes:

**1. Add brief mention of alternative table packages (Claude's discretion).**

In the Setup section, after "For the table examples, we use the `{gt}` package:", add a brief note:
"The `{gt}` package produces HTML tables ideal for pkgdown websites and web-based reports. For Word or PowerPoint output, consider the `{flextable}` or `{huxtable}` packages, which can consume the same `beeca_summary_table()` output."

Keep it to 1-2 sentences. No code examples for alternatives (out of scope).

**2. Add summary takeaway before Session Information.**

Between the "## Complete Reporting Example" section and "## Session Information", add:

```markdown
## Summary

This vignette demonstrated beeca's complete clinical trial table workflow:

- **`get_marginal_effect()`** for covariate-adjusted treatment effect estimation
- **`as_gt()`** for publication-ready regulatory tables with metadata
- **`beeca_summary_table()`** for structured data suitable for custom table creation
- **`beeca_fit()`** for streamlined one-step analysis
- **`tidy()`** and **`summary()`** for flexible result inspection
- **`plot()`** for forest plot visualization

All examples used the `trial02_cdisc` dataset with the Ye et al. (2023) method for robust variance estimation targeting the population average treatment effect (PATE).

**Next steps:**

- For estimand concepts and variance method selection, see `vignette('estimand_and_implementations')`
- For integrating beeca results with the cards ARD framework, see `vignette('ard-cards-integration')`
```

**3. Update references.**

Add DOIs to references where missing:
- Ge et al. (2011): add `https://doi.org/10.1177/009286151104500409`
- Ye et al. (2023): add `https://doi.org/10.1080/24754269.2023.2205802`
- FDA (2023): add URL `https://www.fda.gov/regulatory-information/search-fda-guidance-documents/adjusting-covariates-randomized-clinical-trials-drugs-and-biological-products`

Add Magirr et al. (2025) reference (this vignette doesn't currently cite it, but since it's the core methodology paper for beeca, it should be included):
"Magirr D, Wang C, Przybylski A, Baillie M (2025). Estimating the Variance of Covariate-Adjusted Estimators of Average Treatment Effects in Clinical Trials With Binary Endpoints. *Pharmaceutical Statistics* 24(4): e70021. https://doi.org/10.1002/pst.70021"

Remove any package version numbers if present in references.

**4. No dataset changes needed** - clinical-trial-table already uses trial02_cdisc throughout.
  </action>
  <verify>
Read the file and confirm:
1. Brief mention of flextable/huxtable in Setup section
2. Summary section exists before Session Information
3. Cross-references to both other vignettes in Summary
4. References have DOIs
5. No package version numbers in references
  </verify>
  <done>Clinical-trial-table vignette has summary takeaway with cross-references, alternative table packages mentioned, references updated with DOIs</done>
</task>

<task type="auto">
  <name>Task 3: Verify all vignettes render without errors</name>
  <files>vignettes/estimand_and_implementations.Rmd, vignettes/ard-cards-integration.Rmd, vignettes/clinical-trial-table.Rmd</files>
  <action>
Build all three vignettes to verify they render without errors after all edits.

Run:
```r
Rscript -e "devtools::build_vignettes()"
```

If any vignette fails to build:
1. Read the error message carefully
2. Fix the issue in the affected Rmd file (likely: undefined variable from dataset switch, missing library call, or chunk dependency issue)
3. Re-run build to confirm the fix works

Common issues to watch for after dataset switch in ARD vignette:
- `trial01` referenced somewhere that wasn't caught
- Variable name mismatch (trtp vs TRTP, aval vs AVAL, bl_cov vs SEX/RACE/AGE)
- `reference = "0"` should become `reference = "Placebo"` for trial02_cdisc
- `cards::ard_continuous()` call needs valid continuous variable from trial02_cdisc

After vignettes build successfully, also run:
```r
Rscript -e "devtools::check(vignettes = TRUE)"
```

Or at minimum:
```r
Rscript -e "devtools::check(args = '--no-manual')"
```

Confirm 0 errors and 0 warnings related to vignettes.
  </action>
  <verify>
```bash
# Build vignettes
Rscript -e "devtools::build_vignettes()"
# Should complete without errors

# Run R CMD check
Rscript -e "devtools::check(args = '--no-manual')"
# Should show 0 errors, 0 warnings (or only pre-existing notes)
```
  </verify>
  <done>All three vignettes render without errors, R CMD check passes with no vignette-related issues</done>
</task>

</tasks>

<verification>
After all tasks:
1. `devtools::build_vignettes()` completes without error for all 3 vignettes
2. Cross-references form a complete web: estimand -> clinical-table, estimand -> ARD, clinical-table -> ARD, clinical-table -> estimand, ARD -> estimand, ARD -> clinical-table
3. trial02_cdisc used in primary workflows of all 3 vignettes; trial01 only in estimand comparison section
4. No OSF/preprint references, no package version numbers in any vignette
5. No "Future Enhancements" section in ARD vignette
6. Progressive learning path clear: estimand (Get Started) -> clinical-table (Applications) -> ARD (Applications)
</verification>

<success_criteria>
- ARD vignette opens with motivation scenario, uses trial02_cdisc, no future section
- Clinical-trial-table vignette ends with summary takeaway and cross-references
- All three vignettes build without errors
- R CMD check passes with no vignette-related warnings or errors
- Cross-references consistent across all vignettes using `vignette('name')` syntax
- No stale references (preprints, version numbers) in any vignette
</success_criteria>

<output>
After completion, create `.planning/phases/03-vignette-review/03-02-SUMMARY.md`
</output>
