# Phase 01.1: GEE Longitudinal Extension Feasibility - Research

**Researched:** 2026-02-03
**Domain:** GEE implementation in R, g-computation with longitudinal binary data
**Confidence:** HIGH (for core GEE packages), MEDIUM (for g-computation + GEE integration)

## Summary

This research investigates the feasibility of extending beeca to support longitudinal binary endpoints fitted via Generalized Estimating Equations (GEE). The core question: can beeca's g-computation pipeline accept and work with GEE model objects (glmgee/geeglm) instead of standard glm objects?

**Key findings:**
- Two mature R packages (glmtoolbox and geepack) provide GEE fitting with full S3 method support
- Both packages' predict() methods support newdata arguments (CRITICAL for counterfactual predictions)
- Mancl-DeRouen small-sample corrections are available in glmtoolbox, geess, and geesmv packages
- Firth-penalized GEE is implemented in geessbin (2024) and geefirthr packages
- NO existing R package combines g-computation with GEE for clinical trials
- beeca's pipeline is conceptually compatible BUT requires significant architectural changes

**Primary recommendation:** Proceed with phased approach starting with accepting GEE objects for single-timepoint analysis (Phase 1), followed by multi-timepoint support (Phase 2).

## Standard Stack

### Core GEE Packages

| Package | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| glmtoolbox | ≥2.0.2 (CRAN 2025) | Primary GEE fitting engine | Most comprehensive: M-dR variance built-in, full S3 methods, recent validation paper (R Journal 2023) |
| geepack | ≥1.3.13 (CRAN 2025) | Alternative GEE fitting | Older/more established, but maintainer concerns (open bugs, potential abandonment) |
| geessbin | ≥0.1.0 (2024) | Firth-penalized GEE + bias corrections | New (BMC Med Res Methodol 2024), fills gap for small-sample binary data |
| mvtnorm | ≥1.3 | Multivariate t/normal distributions | Required for MVT-based multiplicity adjustment across timepoints |

### Supporting Packages

| Package | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| geess | Latest | Additional M-dR implementation | Alternative to glmtoolbox for M-dR variance |
| geesmv | Latest | Modified variance estimators | Research/validation comparisons |
| clubSandwich | ≥0.5 (2025) | Cluster-robust variance with CR2 correction | Alternative small-sample correction (CR2 recommended) |
| geefirthr | - | Firth-penalized GEE | Alternative to geessbin |
| geeasy | Latest | Tools for GEE with clustered data | Potential helper functions |

### Alternatives Considered

| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| glmtoolbox | geepack | geepack more established but lacks built-in M-dR, possible maintenance concerns |
| geessbin | geefirthr | geessbin more recent with comprehensive bias corrections (11 methods) |
| Built-in M-dR (glmtoolbox) | geesmv or clubSandwich | External packages offer more variance estimator options but add complexity |

**Installation:**
```r
install.packages(c("glmtoolbox", "geepack", "geessbin", "mvtnorm",
                   "geess", "geesmv", "clubSandwich"))
```

## Architecture Patterns

### GEE Object Structure

**glmgee objects** (from glmtoolbox):
- **Class:** "glmgee"
- **Key slots:** coefficients, fitted.values, linear.predictors, y, formula, call, model, data, score, ids, converged, estfun, R (correlation matrix)
- **Data storage:** model$model (similar to glm) AND model$data
- **Cluster ID:** model$ids (critical for within-subject correlation)

**geeglm objects** (from geepack):
- **Class:** "geeglm"
- **Key slots:** Similar to glmgee but structure differs slightly
- **Data storage:** model$data or model$model
- **Missing data:** geeglm only works on complete data; requires na.omit(mydata) if NAs present

### Pattern 1: Extending S3 Method Dispatch

**What:** Add sanitize_model.glmgee() and sanitize_model.geeglm() methods to accept GEE objects

**When to use:** Phase 1 implementation (single-timepoint GEE support)

**Example:**
```r
# Current beeca (glm only)
sanitize_model.glm <- function(model, trt, ...) {
  # Check family, link, convergence, rank, etc.
  if (model$family$family != "binomial" | model$family$link != "logit") {
    stop("not in the binomial family with logit link function")
  }
  # ... more checks
}

# Proposed extension
sanitize_model.glmgee <- function(model, trt, ...) {
  # Similar checks but adapted for glmgee structure
  if (model$family$family != "binomial") {
    stop("not in the binomial family")
  }

  # NEW: Check cluster ID exists
  if (is.null(model$ids)) {
    stop("GEE model must have cluster ID (ids)")
  }

  # RELAXED: Allow Trt x Time interactions (essential for longitudinal)
  # (current beeca blocks ALL treatment interactions)

  # ... adapt other checks
}
```

**Source:** Adapted from beeca's R/sanitize.R (lines 36-91)

### Pattern 2: Counterfactual Predictions with GEE

**What:** Generate counterfactual predictions using GEE predict() method

**When to use:** Core pipeline function, must work for both single and multi-timepoint

**Critical finding:** Both glmgee and geeglm support predict(object, newdata, type="response")

**Example:**
```r
# From glmtoolbox documentation
data(depression)
fit <- glmgee(depressd ~ visit + group, id=subj,
              family=binomial(logit), data=depression)

newdata <- data.frame(visit=c(6,6),
                      group=as.factor(c("placebo","oestrogen")))

predict(fit, newdata=newdata, type="response", se.fit=TRUE)
```

**Source:** [glmtoolbox predict.glmgee documentation](https://rdrr.io/cran/glmtoolbox/man/predict.glmgee.html)

**Implication for beeca:** Current predict_counterfactuals() function (lines 58-83) should work with minimal modification IF:
1. S3 dispatch works correctly (predict() calls predict.glmgee internally)
2. Data structure is compatible (glmgee stores data in model$model like glm)

### Pattern 3: Variance Estimation - Replacing sandwich::vcovHC with GEE vcov

**What:** Use GEE model's built-in cluster-robust variance instead of sandwich::vcovHC()

**When to use:** estimate_varcov() function, Ge method path

**Current beeca (Ge method):**
```r
# From R/estimate_varcov.R line 291
V <- sandwich::vcovHC(object, type = type)  # HC0, HC1, HC2, HC3, etc.
```

**Proposed for GEE:**
```r
# Use GEE's native vcov with appropriate type
V <- vcov(object, type = "bias-corrected")  # Mancl-DeRouen
# OR
V <- vcov(object, type = "df-adjusted")
# OR
V <- vcov(object, type = "robust")  # Standard sandwich
```

**glmtoolbox vcov types:**
- "robust" - Standard GEE sandwich
- "df-adjusted" - Degrees-of-freedom correction
- "bias-corrected" - Mancl-DeRouen estimator
- "model" - Model-based (not robust)
- "jackknife" - Jackknife variance

**Source:** [vcov.glmgee documentation](https://rdrr.io/cran/glmtoolbox/man/vcov.glmgee.html)

### Pattern 4: Multi-Timepoint Marginal Means

**What:** Average predictions within timepoint-treatment cells instead of just treatment cells

**When to use:** Phase 2 (multi-timepoint support)

**Current beeca (single timepoint):**
```r
# From R/average_predictions.R
# Returns K-length vector (K = number of treatment levels)
cf_means <- colMeans(object$counterfactual.predictions)
```

**Proposed for longitudinal:**
```r
# Returns K x T matrix (K treatments x T timepoints)
# Assuming counterfactual.predictions has timepoint column
cf_means_by_time <- object$counterfactual.predictions %>%
  group_by(timepoint, treatment) %>%
  summarise(mean_pred = mean(prediction), .groups = "drop") %>%
  pivot_wider(names_from = c(treatment, timepoint),
              values_from = mean_pred)
```

### Pattern 5: Multiplicity Adjustment with MVT

**What:** Adjust p-values across multiple timepoints using multivariate t distribution

**When to use:** Phase 3 (multiplicity adjustment)

**Approach:** Use joint variance-covariance matrix (from estimate_varcov) with mvtnorm::pmvt()

**Reference:** Standard in longitudinal trials; similar to MMRM multiplicity adjustment

### Anti-Patterns to Avoid

- **Don't assume glm structure:** GEE objects have different internal structure (no $qr$rank, different $family storage)
- **Don't use sandwich::vcovHC for GEE:** It assumes independence; use GEE's native vcov() instead
- **Don't ignore cluster ID:** Longitudinal data requires tracking subject/cluster identifier throughout
- **Don't block treatment interactions blanket:** Trt x Time interactions are ESSENTIAL for longitudinal analysis (current beeca blocks on line 50-55 of sanitize.R)
- **Don't assume single observation per subject:** Longitudinal data has multiple rows per subject

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| GEE fitting | Custom GEE estimator | glmtoolbox::glmgee | Handles correlation structures, convergence, edge cases; validated in R Journal 2023 |
| Mancl-DeRouen variance | Custom bias correction | vcov(glmgee_obj, type="bias-corrected") | Proper leverage matrix computation, validated implementation |
| Small-sample binary GEE | Custom penalization | geessbin package | 11 bias-adjusted covariance estimators, Firth penalization, peer-reviewed (BMC 2024) |
| Clustered variance | Custom sandwich | vcov() method from GEE package | Accounts for working correlation, cluster structure |
| MVT multiplicity | Custom p-value adjustment | mvtnorm::pmvt() | Standard reference implementation, handles multivariate t |

**Key insight:** GEE variance estimation is FAR more complex than GLM because it must account for within-cluster correlation and small-sample bias. The working correlation structure (exchangeable, AR(1), unstructured) affects the variance, and Mancl-DeRouen corrections involve cluster-specific leverage matrices. Don't attempt to reimplement.

## Common Pitfalls

### Pitfall 1: Assuming predict() Works the Same

**What goes wrong:** GEE predict() methods may have different default behaviors or requirements

**Why it happens:** glmgee and geeglm are not exact drop-in replacements for glm despite similar interfaces

**How to avoid:**
- Always test predict(gee_model, newdata=df, type="response") with actual GEE objects
- Verify that predictions are on probability scale [0,1] for binomial
- Check if se.fit argument behavior differs

**Warning signs:** Predictions outside [0,1], errors about "newdata must contain cluster ID", unexpected NA values

### Pitfall 2: Using Ye Variance Method with GEE

**What goes wrong:** Ye et al. (2023) variance decomposition was derived for independent observations only

**Why it happens:** The method uses per-subject residuals assuming independence; doesn't extend to clustered data

**How to avoid:**
- Disable Ye method for GEE objects in estimate_varcov()
- Only support Ge (delta method) approach with GEE's cluster-robust variance
- Document this limitation clearly

**Warning signs:** Variance estimates that ignore correlation structure, inflated Type I error

### Pitfall 3: Missing Data Handling Differences

**What goes wrong:** geeglm requires complete data (no NAs), while glm uses na.action

**Why it happens:** GEE estimation requires balanced cluster structure or explicit handling of missingness

**How to avoid:**
- Check for NAs and throw clear error message for geeglm
- Consider using na.omit() or multiple imputation before GEE fitting
- Document that users must handle missing data before calling beeca

**Warning signs:** Cryptic errors about "unequal cluster sizes" or "invalid data"

### Pitfall 4: Treatment-by-Time Interaction Blocking

**What goes wrong:** beeca currently blocks ALL treatment interactions (sanitize.R lines 50-55)

**Why it happens:** For single-timepoint trials, Trt-by-Covariate interactions violate assumptions

**How to avoid:**
- Relax interaction check specifically for GEE models
- Allow Trt x Time interactions (essential for longitudinal)
- Still block Trt x Baseline_Covariate interactions

**Warning signs:** Error "with treatment-covariate interaction terms" when Trt:Visit is necessary

### Pitfall 5: Cluster ID Not Tracked

**What goes wrong:** beeca doesn't currently track or validate subject/cluster identifiers

**Why it happens:** Single-timepoint trials with independent observations don't need cluster IDs

**How to avoid:**
- Add cluster ID validation in sanitize_model.glmgee()
- Store cluster ID variable name in model object attributes
- Ensure cluster ID is carried through all pipeline steps

**Warning signs:** Variance estimates that don't account for within-subject correlation

## Code Examples

Verified patterns from official sources:

### Fitting GEE with glmtoolbox

```r
# Binary longitudinal outcome example
# Source: glmtoolbox documentation
library(glmtoolbox)

# Data structure: one row per subject-visit
# - subj: cluster/subject ID
# - visit: timepoint variable
# - depressd: binary outcome (0/1)
# - group: treatment factor

data(depression)

# Fit GEE with exchangeable correlation
fit <- glmgee(depressd ~ visit + group,
              id = subj,  # CRITICAL: cluster ID
              family = binomial(logit),
              data = depression,
              corstr = "Exchangeable")

# Extract variance-covariance with Mancl-DeRouen
V <- vcov(fit, type = "bias-corrected")

# Predictions with newdata
newdata <- data.frame(visit = c(6, 6),
                      group = as.factor(c("placebo", "oestrogen")))
preds <- predict(fit, newdata = newdata, type = "response", se.fit = TRUE)
```

**Source:** [glmtoolbox documentation](https://cran.r-project.org/web/packages/glmtoolbox/glmtoolbox.pdf)

### Getting Cluster-Robust Variance

```r
# Multiple variance estimator types available

# Standard robust (sandwich)
V1 <- vcov(fit, type = "robust")

# Mancl-DeRouen (small-sample bias correction)
V2 <- vcov(fit, type = "bias-corrected")

# DF-adjusted
V3 <- vcov(fit, type = "df-adjusted")

# Model-based (not robust - for comparison)
V4 <- vcov(fit, type = "model")

# Jackknife
V5 <- vcov(fit, type = "jackknife")
```

**Source:** [vcov.glmgee documentation](https://rdrr.io/cran/glmtoolbox/man/vcov.glmgee.html)

### Small-Sample Binary GEE with Firth Penalization

```r
# Using geessbin package for rare events / separation
# Source: BMC Med Res Methodol 2024;24:268
library(geessbin)

# PGEE: Penalized GEE (Firth-like)
# Syntax similar to glmgee but with penalization
fit_firth <- geefirth(outcome ~ time + treatment,
                      id = subject_id,
                      data = mydata,
                      family = binomial,
                      corstr = "exchangeable")

# Package includes 11 bias-adjusted covariance estimators:
# - Standard GEE
# - BCGEE (bias-corrected GEE)
# - PGEE (penalized GEE)
# - All with multiple small-sample variance corrections
```

**Source:** [geessbin: BMC Med Res Methodol (2024)](https://link.springer.com/article/10.1186/s12874-024-02368-2)

### Testing predict() with counterfactuals

```r
# Verify predict works for beeca-style counterfactuals
library(glmtoolbox)
data(depression)

fit <- glmgee(depressd ~ visit + group,
              id = subj,
              family = binomial(logit),
              data = depression)

# Create counterfactual data: set everyone to "oestrogen"
cf_data <- depression
cf_data$group <- factor("oestrogen", levels = levels(depression$group))

# Test if predict works
cf_preds <- predict(fit, newdata = cf_data, type = "response")

# Verify predictions are valid
stopifnot(all(cf_preds >= 0 & cf_preds <= 1))
stopifnot(length(cf_preds) == nrow(cf_data))

# This confirms: glmgee predict() supports beeca's counterfactual approach
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| geepack dominant | glmtoolbox emerging as standard | 2023 (R Journal publication) | glmtoolbox has M-dR built-in, more complete S3 methods |
| Separate variance correction packages | Built-in bias corrections | 2024 (geessbin) | Unified workflow for small-sample binary GEE |
| Manual MVT adjustment | Integrated multiplicity in trial packages | Ongoing | Still need to implement for beeca |
| GEE for point estimates only | G-computation + GEE | Not yet implemented | Would be novel contribution |

**Deprecated/outdated:**
- gee package (original): Use geepack or glmtoolbox instead (more features, better maintained)
- Manual implementation of Mancl-DeRouen: Use glmtoolbox built-in (validated)
- geepack possibly being abandoned: Issue #1148 on marginaleffects GitHub notes "seems to be abandoned, with lots of old issues and some serious bugs"

## Open Questions

Things that couldn't be fully resolved:

1. **Does beeca's Ye variance method have ANY path forward for GEE?**
   - What we know: Original Ye et al. (2023) paper assumes independence
   - What's unclear: Could the variance decomposition be modified for clustered data?
   - Recommendation: Start by marking Ye method as "not supported for GEE objects" in Phase 1; consider theoretical extension in future research

2. **How does RobinCar handle longitudinal binary endpoints?**
   - What we know: RobinCar is already in beeca's Suggests; has been developing extensions
   - What's unclear: Current capabilities for longitudinal binary (search failed)
   - Recommendation: Review RobinCar >= 0.3.0 documentation/vignettes; contact maintainers if needed

3. **Should this be a separate package (beecal) or extend beeca?**
   - What we know: beeca name/scope is "Binary Endpoint Estimation" (singular endpoint assumed)
   - What's unclear: Community preference, maintenance burden, GxP validation implications
   - Recommendation: Start with Phase 1 (single-timepoint GEE in beeca); decide on separate package if Phase 2+ adds substantial complexity

4. **How do marginaleffects and emmeans handle glmgee objects?**
   - What we know: ggeffects supports glmgee (confirmed), marginaleffects Issue #1148 requests support
   - What's unclear: Current status of marginaleffects direct support (search inconclusive)
   - Recommendation: Test integration; may inform beeca's approach to marginal effects

5. **Ordinal GEE extension scope**
   - What we know: User requested ordinal endpoint support; this is a major departure
   - What's unclear: Is proportional odds GEE with g-computation feasible/needed?
   - Recommendation: Separate consideration; much larger scope than binary longitudinal

## Sources

### Primary (HIGH confidence)

- [glmtoolbox CRAN package (July 2025)](https://cran.r-project.org/web/packages/glmtoolbox/glmtoolbox.pdf) - Official documentation
- [glmtoolbox R Journal article (2023)](https://journal.r-project.org/articles/RJ-2023-056/) - Validation paper: Vanegas et al., "Generalized Estimating Equations using the new R package glmtoolbox", R Journal 15:105-133
- [geepack CRAN package (Oct 2025)](https://cran.r-project.org/web/packages/geepack/geepack.pdf) - Official documentation
- [vcov.glmgee documentation](https://rdrr.io/cran/glmtoolbox/man/vcov.glmgee.html) - Mancl-DeRouen implementation details
- [predict.glmgee documentation](https://rdrr.io/cran/glmtoolbox/man/predict.glmgee.html) - Confirmed newdata support
- [geessbin: BMC Med Res Methodol (2024)](https://link.springer.com/article/10.1186/s12874-024-02368-2) - Firth-penalized GEE peer-reviewed paper
- [Mancl & DeRouen (2001), Biometrics 57(1):126-34](https://pubmed.ncbi.nlm.nih.gov/11252587/) - Original small-sample correction paper

### Secondary (MEDIUM confidence)

- [geess CRAN package (July 2025)](https://cran.r-project.org/web/packages/geess/geess.pdf) - Alternative M-dR implementation
- [clubSandwich CRAN package (July 2025)](https://cran.r-project.org/web/packages/clubSandwich/clubSandwich.pdf) - CR2 cluster-robust variance
- [geesmv CRAN package (July 2025)](https://cran.r-project.org/web/packages/geesmv/geesmv.pdf) - Modified variance estimators
- [marginaleffects Issue #1148](https://github.com/vincentarelbundock/marginaleffects/issues/1148) - glmgee support request
- [Small Sample Performance of Bias-corrected Sandwich Estimators (PMC4268228)](https://pmc.ncbi.nlm.nih.gov/articles/PMC4268228/) - Performance comparisons
- [ggeffects package](https://strengejacke.github.io/ggeffects/) - Confirmed glmgee support

### Tertiary (LOW confidence)

- WebSearch results on "g-computation GEE" - Found qgcomp, gfoRmula, but not specifically for clinical trial GEE
- Community discussions about geepack maintenance status - Anecdotal concerns about abandonment

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - Official CRAN packages with recent updates (2024-2025), peer-reviewed
- GEE object structure: HIGH - Verified from official documentation and source code
- predict() newdata support: HIGH - Confirmed in official docs with examples
- Mancl-DeRouen implementation: HIGH - Built into glmtoolbox, documented
- G-computation + GEE integration: MEDIUM - No existing implementation found; conceptual feasibility confirmed but no working reference
- Ye method extension: LOW - No published research on extending to clustered data
- RobinCar longitudinal support: LOW - Could not verify current capabilities

**Research date:** 2026-02-03
**Valid until:** 2026-05-03 (90 days - packages stable, methodological landscape slow-moving)

## Critical Findings for Planning

### What MUST work for Phase 1 (Accept GEE objects, single timepoint):

1. ✅ **S3 dispatch for sanitize_model()** - Straightforward to implement
2. ✅ **predict() with newdata** - CONFIRMED to work for glmgee and geeglm
3. ✅ **vcov() for cluster-robust variance** - Available via type argument
4. ✅ **Ge delta method** - Just replace sandwich::vcovHC() with vcov(gee_obj)
5. ❌ **Ye variance method** - NOT applicable; must be disabled for GEE

### What needs deeper investigation for Phase 2 (Multi-timepoint):

1. ⚠️ **Timepoint-stratified averaging** - Conceptually clear but untested
2. ⚠️ **Treatment x Time interactions** - Must relax current blocking
3. ⚠️ **Joint (K x T) variance matrix** - Larger matrix, same delta method principle
4. ⚠️ **MVT multiplicity** - Standard approach but needs integration

### Blockers:

- None identified for Phase 1
- For Phase 2: Need decision on whether multi-timepoint belongs in beeca vs companion package

### Next Steps for Planner:

1. Design Phase 1 tasks around extending S3 methods for glmgee/geeglm
2. Plan testing strategy using glmtoolbox's example datasets (depression, spruces)
3. Consider validation approach: cross-validate against glmtoolbox's own variance estimates
4. Decide on dependency management: glmtoolbox to Imports or Suggests?
5. Plan documentation updates: new vignette for GEE support
