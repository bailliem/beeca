% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/get_marginal_effect.R
\name{get_marginal_effect}
\alias{get_marginal_effect}
\title{Estimate marginal treatment effects using a GLM working model}
\usage{
get_marginal_effect(
  object,
  trt,
  strata = NULL,
  method = "Ge",
  type = "HC0",
  contrast = "diff",
  reference,
  mod = FALSE
)
}
\arguments{
\item{object}{a fitted model object. Supported types:
\itemize{
\item \code{\link[stats]{glm}} with binomial family and logit link
\item \code{glmgee} from \code{\link[glmtoolbox]{glmgee}} (requires \pkg{glmtoolbox})
\item \code{geeglm} from \code{\link[geepack]{geeglm}} (requires \pkg{geepack})
}
For GEE objects, only single-timepoint data (one observation per cluster)
is currently supported.}

\item{trt}{a string specifying the name of the treatment variable
in the model formula. It must be one of the linear predictor variables used
in fitting the \code{object}.}

\item{strata}{an optional string or vector of strings specifying the names
of stratification variables. Relevant only for Ye's method and used to
adjust the variance-covariance estimation for stratification.
If provided, each specified variable must be present in the model.}

\item{method}{a string indicating the chosen method for variance estimation.
Supported methods are \code{Ge} and \code{Ye}. The default method is \code{Ge} based on Ge
et al (2011) which is suitable for the variance estimation of conditional
average treatment effect. The method \code{Ye} is based on Ye et al (2023) and is
suitable for the variance estimation of population average treatment effect.
For more details, see Magirr et al. (2025) \doi{10.1002/pst.70021}.
Note: For GEE objects, only \code{Ge} is supported.}

\item{type}{a string indicating the type of
variance estimator to use (only applicable for Ge's method). For \code{glm} objects: supported types
include HC0 (default), model-based, HC3, HC, HC1, HC2, HC4, HC4m, and HC5.
See \link[sandwich]{vcovHC} for heteroscedasticity-consistent estimators.
For \code{glmgee} objects: supported types are "robust" (default),
"bias-corrected", and "df-adjusted".
For \code{geeglm} objects: only "robust" is supported.}

\item{contrast}{a string indicating choice of contrast. Defaults to 'diff' for a risk difference. See \link[beeca]{apply_contrast}.}

\item{reference}{a string or list of strings indicating which treatment
group(s) to use as reference level for pairwise comparisons. Accepted values
must be a subset of the levels in the treatment variable. Default to the
first n-1 treatment levels used in the \code{glm} object. This parameter influences
the calculation of treatment effects relative to the chosen reference group.}

\item{mod}{for Ye's method, the implementation of open-source RobinCar package
has an additional variance decomposition step when estimating the robust variance,
which then utilizes different counterfactual outcomes than the original reference.
Set \code{mod = TRUE} to use exactly the implementation method described in
Ye et al (2022), default to \code{FALSE} to use the modified implementation in
RobinCar and Bannick et al (2023) which improves stability.}
}
\value{
an updated model object (of the same class as the input) appended with marginal estimate components:
counterfactual.predictions (see \link[beeca]{predict_counterfactuals}),
counterfactual.means (see \link[beeca]{average_predictions}),
robust_varcov (see \link[beeca]{estimate_varcov}),
marginal_est, marginal_se (see \link[beeca]{apply_contrast}) and marginal_results. A summary is shown below
\tabular{ll}{
counterfactual.predictions \tab Counterfactual predictions based on the working model. For each subject in the input glm data, the potential outcomes are obtained by assigning subjects to each of the possible treatment variable levels. Each prediction is associated with a descriptive label explaining the counterfactual scenario. \cr
counterfactual.means       \tab Average of the counterfactual predictions for each level of the treatment variable. \cr
robust_varcov              \tab Variance-covariance matrix of the marginal effect estimate for each level of treatment variable, with estimation method indicated in the attributes.\cr
marginal_est               \tab Marginal treatment effect estimate for a given contrast.\cr
marginal_se                \tab Standard error estimate of the marginal treatment effect estimate. \cr
marginal_results           \tab Analysis results data (ARD) containing a summary of the analysis for subsequent reporting. \cr
}
}
\description{
Estimates the marginal treatment effect from a logistic regression working model
or GEE model using a specified choice of variance estimator and contrast.
}
\details{
The \code{get_marginal_effect} function is a wrapper that facilitates
advanced variance estimation techniques for GLM models with covariate adjustment
targeting a population average treatment effect. It is particularly useful in clinical trial analysis
and other fields requiring robust statistical inference.
It allows researchers to account for complex study designs,
including stratification and treatment contrasts, by providing a flexible
interface for variance-covariance estimation.

For GEE objects (\code{glmgee} or \code{geeglm}), only the Ge et al. (2011)
method is supported. Ye's method assumes independence and is not valid for
GEE. The default variance type for GEE is "robust". See
\code{\link{estimate_varcov}} for available GEE variance types.
}
\examples{
trial01$trtp <- factor(trial01$trtp)
fit1 <- glm(aval ~ trtp + bl_cov, family = "binomial", data = trial01) |>
  get_marginal_effect(trt = "trtp", method = "Ye", contrast = "diff", reference = "0")
fit1$marginal_results

\donttest{
# GEE example (requires glmtoolbox)
if (requireNamespace("glmtoolbox", quietly = TRUE)) {
  library(glmtoolbox)
  trial01$trtp <- factor(trial01$trtp)
  trial01$id <- seq_len(nrow(trial01))
  fit_gee <- glmgee(aval ~ trtp + bl_cov, id = id,
                     family = binomial(link = "logit"),
                     corstr = "independence", data = trial01)
  result <- get_marginal_effect(fit_gee, trt = "trtp",
                                 method = "Ge", contrast = "diff",
                                 reference = "0")
  result$marginal_results
}
}
}
\seealso{
\code{\link[=predict_counterfactuals]{predict_counterfactuals()}} for generating counterfactual predictions

\code{\link[=average_predictions]{average_predictions()}} for averaging counterfactual predictions

\code{\link[=estimate_varcov]{estimate_varcov()}} for robust variance estimation

\code{\link[=apply_contrast]{apply_contrast()}} for computing treatment contrasts

\code{\link[=beeca_fit]{beeca_fit()}} for streamlined convenience wrapper

\code{\link[=tidy.beeca]{tidy.beeca()}} for tidied parameter estimates

\code{\link[=summary.beeca]{summary.beeca()}} for detailed summary output

\code{\link[=print.beeca]{print.beeca()}} for concise output

\code{\link[=plot.beeca]{plot.beeca()}} and \code{\link[=plot_forest]{plot_forest()}} for visualizations

\code{\link[=augment.beeca]{augment.beeca()}} for augmented data with predictions

\code{\link[=as_gt]{as_gt()}} for publication-ready tables

\code{\link[=beeca_to_cards_ard]{beeca_to_cards_ard()}} for cards ARD integration
}
