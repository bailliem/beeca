% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/estimate_varcov.R
\name{estimate_varcov}
\alias{estimate_varcov}
\title{Estimate variance-covariance matrix for marginal estimand based on GLM model}
\usage{
estimate_varcov(
  object,
  strata = NULL,
  method = c("Ge", "Ye"),
  type = c("HC0", "model-based", "HC3", "HC", "HC1", "HC2", "HC4", "HC4m", "HC5"),
  mod = FALSE
)
}
\arguments{
\item{object}{a fitted model object (\code{\link[stats]{glm}}, \code{glmgee},
or \code{geeglm}) augmented with \code{counterfactual.predictions} and
\code{counterfactual.means} from prior pipeline steps.}

\item{strata}{an optional string or vector of strings specifying the names
of stratification variables. Relevant only for Ye's method and used to
adjust the variance-covariance estimation for stratification.
If provided, each specified variable must be present in the model.}

\item{method}{a string indicating the chosen method for variance estimation.
Supported methods are \code{Ge} and \code{Ye}. The default method is \code{Ge} based on Ge
et al (2011) which is suitable for the variance estimation of conditional
average treatment effect. The method \code{Ye} is based on Ye et al (2023) and is
suitable for the variance estimation of population average treatment effect.
For more details, see Magirr et al. (2025) \doi{10.1002/pst.70021}.
Note: For GEE objects, only \code{Ge} is supported. Ye's method assumes
independence and is not valid for GEE models.}

\item{type}{a string indicating the type of variance estimator to use
(only applicable for Ge's method). Supported types depend on the model class:

For \code{glm} objects:
\itemize{
\item HC0 (default) - Heteroscedasticity-consistent (White's estimator)
\item model-based - Model-based variance
\item HC1, HC2, HC3, HC4, HC4m, HC5 - Alternative HC estimators
}
See \link[sandwich]{vcovHC} for details.

For \code{glmgee} objects:
\itemize{
\item "robust" (default) - Robust sandwich estimator
\item "bias-corrected" - Bias-corrected sandwich estimator (Mancl-DeRouen)
\item "df-adjusted" - Degrees-of-freedom adjusted estimator
}

For \code{geeglm} objects:
\itemize{
\item "robust" (only option) - Robust sandwich estimator
}

Passing a GLM-style type (e.g., "HC0") to a GEE object will produce an
informative error listing valid GEE types.}

\item{mod}{For Ye's method, the implementation of open-source RobinCar package
has an additional variance decomposition step when estimating the robust variance,
which then utilizes different counterfactual outcomes than the original reference.
Set \code{mod = TRUE} to use exactly the implementation method described in
Ye et al (2022), default to \code{FALSE} to use the modified implementation in
RobinCar and Bannick et al (2023) which improves stability.}
}
\value{
an updated model object (of the same class as the input) appended with an
additional component \code{robust_varcov}, which is the estimated variance-covariance matrix
of the marginal effect. The matrix format and estimation method are
indicated in the matrix attributes.
}
\description{
Main variance estimation function. Estimates the variance-covariance
matrix of a marginal estimand for a GLM or GEE model object
using specified methods. This function supports both Ge's and Ye's methods
for variance estimation, accommodating different estimand specifications.
}
\details{
The \code{estimate_varcov} function facilitates robust variance estimation
techniques for GLM models, particularly useful in clinical trial analysis
and other fields requiring robust statistical inference. It allows
researchers to account for complex study designs,
including stratification and different treatment contrasts,
by providing a flexible interface for variance-covariance estimation.

For GEE objects, variance estimation uses the delta method with GEE's
robust sandwich estimator obtained via \code{vcov()}. This replaces the
\code{sandwich::vcovHC} approach used for standard GLM objects. See
Ge et al. (2011) for the delta method methodology.

Note: Ensure that the model object has been adequately prepared with
\code{\link{predict_counterfactuals}} and \code{\link{average_predictions}}
before applying \code{estimate_varcov()}. Failure to do so may result in
errors indicating missing components.
}
\examples{
# Example usage with a binary outcome GLM model
trial01$trtp <- factor(trial01$trtp)
fit1 <- glm(aval ~ trtp + bl_cov, family = "binomial", data = trial01)

#' # Preprocess fit1 as required by estimate_varcov
fit2 <- fit1 |>
  predict_counterfactuals(trt = "trtp") |>
  average_predictions()

# Estimate variance-covariance using Ge's method
fit3_ge <- estimate_varcov(fit2, method = "Ge")
print(fit3_ge$robust_varcov)


# Estimate variance-covariance using Ye's method with stratification
fit4 <- glm(aval ~ trtp + bl_cov_c, family = "binomial", data = trial01) |>
  predict_counterfactuals(trt = "trtp") |>
  average_predictions()
fit4_ye <- estimate_varcov(fit4, method = "Ye", strata = "bl_cov_c")
print(fit4_ye$robust_varcov)

}
\references{
Ye, T., Shao, J., Yi, Y., and Zhao, Q. (2023). "Robust Variance
Estimation for Covariate-Adjusted Unconditional Treatment Effect in Randomized
Clinical Trials with Binary Outcomes." \emph{Statistical Theory and Related Fields}
7(2): 159-163. \url{https://doi.org/10.1080/24754269.2023.2205802}

Ge, M., Durham, L. K., Meyer, R. D., Xie, W., and Flournoy, N. (2011).
"Covariate-Adjusted Difference in Proportions from Clinical Trials Using Logistic
Regression and Weighted Risk Differences." \emph{Drug Information Journal} 45(4): 481-493.
\url{https://doi.org/10.1177/009286151104500409}

Bannick, M. S., Jun, Y., Josey, K., Weinberg, C. R., and Karlson, E. W.
(2023). "A General Form of Covariate Adjustment in Randomized Clinical Trials."
arXiv preprint arXiv:2306.10213. \url{https://arxiv.org/abs/2306.10213}
}
\seealso{
\code{\link[=predict_counterfactuals]{predict_counterfactuals()}} for generating counterfactual predictions

\code{\link[=average_predictions]{average_predictions()}} for averaging counterfactual predictions

\code{\link[=apply_contrast]{apply_contrast()}} for computing a summary measure

\code{\link[=get_marginal_effect]{get_marginal_effect()}} for estimating marginal effects directly
from an original \code{\link[stats]{glm}} object

\code{\link[=beeca_fit]{beeca_fit()}} for streamlined analysis pipeline
}
