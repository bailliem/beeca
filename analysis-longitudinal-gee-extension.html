<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Analysis: Extending beeca for Longitudinal / GEE Settings • beeca</title><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Analysis: Extending beeca for Longitudinal / GEE Settings"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">beeca</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="articles/estimand_and_implementations.html">Introduction to estimating a marginal estimand with beeca</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Applications</h6></li>
    <li><a class="dropdown-item" href="articles/clinical-trial-table.html">Creating Clinical Trial Tables with beeca</a></li>
    <li><a class="dropdown-item" href="articles/ard-cards-integration.html">Integration with cards ARD Framework</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/openpharma/beeca/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Analysis: Extending beeca for Longitudinal / GEE Settings</h1>
      <small class="dont-index">Source: <a href="https://github.com/openpharma/beeca/blob/main/analysis-longitudinal-gee-extension.md" class="external-link"><code>analysis-longitudinal-gee-extension.md</code></a></small>
    </div>

<div id="analysis-extending-beeca-for-longitudinal--gee-settings" class="section level1">

<div class="section level2">
<h2 id="issue-summary">Issue Summary<a class="anchor" aria-label="anchor" href="#issue-summary"></a></h2>
<p>A user requests that beeca be extended to support <strong>longitudinal studies with binary (and ordinal) endpoints</strong> fitted via <strong>Generalized Estimating Equations (GEE)</strong>, with support for:</p>
<ol style="list-style-type: decimal"><li>GEE estimation for non-Gaussian outcomes (logistic, ordinal)</li>
<li>Small-sample variance corrections (Mancl-DeRouen)</li>
<li>Firth-like penalised GEE logistic regression</li>
<li>Multiplicity adjustment (MVT-based, gatekeeping) across multiple timepoints</li>
<li>Integration with packages like <code>glmtoolbox</code>, <code>geesbin</code>, <code>mice</code>, <code>emmeans</code>
</li>
</ol><hr></div>
<div class="section level2">
<h2 id="id_1-current-beeca-architecture-and-assumptions">1. Current beeca Architecture and Assumptions<a class="anchor" aria-label="anchor" href="#id_1-current-beeca-architecture-and-assumptions"></a></h2>
<div class="section level3">
<h3 id="core-statistical-identity">Core statistical identity<a class="anchor" aria-label="anchor" href="#core-statistical-identity"></a></h3>
<p>beeca implements <strong>g-computation</strong> (standardisation) for binary endpoints from a <strong>single-timepoint, cross-sectional GLM</strong>:</p>
<pre><code><span><span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Trt</span> <span class="op">+</span> <span class="va">Covariates</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span><span class="va">logit</span><span class="op">)</span>, <span class="va">data</span><span class="op">)</span></span></code></pre>
<p>The pipeline is:</p>
<ol style="list-style-type: decimal"><li>
<strong>Fit</strong> a logistic regression working model</li>
<li>
<strong>Predict counterfactuals</strong>: for every subject, predict P(Y=1) under each treatment assignment</li>
<li>
<strong>Average</strong> counterfactual predictions per arm → marginal means</li>
<li>
<strong>Estimate variance</strong> using either:
<ul><li>
<strong>Ge et al. (2011)</strong>: delta-method + HC sandwich on the GLM parameter variance → CATE</li>
<li>
<strong>Ye et al. (2023)</strong>: variance decomposition using residuals and counterfactual predictions → PATE</li>
</ul></li>
<li>
<strong>Apply contrast</strong>: risk difference, risk ratio, odds ratio (+ log-transformed)</li>
</ol></div>
<div class="section level3">
<h3 id="key-assumptions-baked-into-the-code">Key assumptions baked into the code<a class="anchor" aria-label="anchor" href="#key-assumptions-baked-into-the-code"></a></h3>
<table class="table"><colgroup><col width="33%"><col width="33%"><col width="33%"></colgroup><thead><tr class="header"><th>Assumption</th>
<th>Where enforced</th>
<th>Implication for GEE</th>
</tr></thead><tbody><tr class="odd"><td>Single binary outcome per subject</td>
<td>
<code><a href="reference/sanitize_variable.html">sanitize_variable()</a></code> checks 0/1 coding</td>
<td>GEE has repeated measurements per subject</td>
</tr><tr class="even"><td>
<code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">stats::glm()</a></code> object as input</td>
<td>
<code><a href="reference/sanitize_model.glm.html">sanitize_model.glm()</a></code>, S3 dispatch on class <code>"glm"</code>
</td>
<td>GEE objects are class <code>"glmgee"</code> (glmtoolbox) or <code>"geeglm"</code> (geepack)</td>
</tr><tr class="odd"><td>Independent observations</td>
<td>Ge variance uses <code><a href="https://sandwich.R-Forge.R-project.org/reference/vcovHC.html" class="external-link">sandwich::vcovHC()</a></code> which assumes independence</td>
<td>GEE explicitly models within-cluster correlation</td>
</tr><tr class="even"><td>
<code><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix()</a></code> and <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> from stats</td>
<td>
<code><a href="reference/predict_counterfactuals.html">predict_counterfactuals()</a></code> calls <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">stats::predict()</a></code>
</td>
<td>GEE objects need their own <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> methods</td>
</tr><tr class="odd"><td>
<code>$y</code>, <code>$qr</code>, <code>$converged</code>, <code>$family</code>, <code>$terms</code> slots</td>
<td>Used throughout sanitize/varcov code</td>
<td>GEE objects have different internal structures</td>
</tr><tr class="even"><td>No cluster/subject identifier</td>
<td>Not tracked anywhere</td>
<td>GEE requires cluster ID for correlation structure</td>
</tr></tbody></table><hr></div>
</div>
<div class="section level2">
<h2 id="id_2-methodological-implications">2. Methodological Implications<a class="anchor" aria-label="anchor" href="#id_2-methodological-implications"></a></h2>
<div class="section level3">
<h3 id="id_21-what-changes-conceptually">2.1 What changes conceptually<a class="anchor" aria-label="anchor" href="#id_21-what-changes-conceptually"></a></h3>
<p>In a <strong>single-timepoint</strong> trial with binary endpoint: - <strong>Estimand</strong>: P(Y=1 | Trt=A) - P(Y=1 | Trt=B) (risk difference at one timepoint) - <strong>Working model</strong>: logistic regression - <strong>Variance</strong>: robust sandwich or variance decomposition</p>
<p>In a <strong>longitudinal</strong> trial with binary endpoint at multiple visits: - <strong>Estimand(s)</strong>: Risk difference at each timepoint t ∈ {t₁, t₂, …, tₖ} - Primary: one designated timepoint - Secondary: remaining timepoints - <strong>Working model</strong>: GEE logistic regression with working correlation (exchangeable, AR(1), unstructured, etc.) - <strong>Variance</strong>: GEE sandwich estimator (or Mancl-DeRouen corrected), which accounts for within-subject correlation - <strong>Multiplicity</strong>: MVT adjustment or gatekeeping across timepoints</p>
</div>
<div class="section level3">
<h3 id="id_22-marginal-vs-conditional-estimands">2.2 Marginal vs. conditional estimands<a class="anchor" aria-label="anchor" href="#id_22-marginal-vs-conditional-estimands"></a></h3>
<p>This is where beeca’s current framework actually aligns well conceptually:</p>
<ul><li>
<strong>GEE already targets marginal (population-averaged) effects</strong> — this is the defining feature of GEE vs. GLMM</li>
<li>beeca’s g-computation approach also targets marginal effects via standardisation</li>
<li>The fundamental question becomes: <strong>do you need g-computation on top of GEE, or does the GEE marginal model suffice?</strong>
</li>
</ul><p><strong>Key insight</strong>: In the longitudinal GEE context, the primary reason to use g-computation/standardisation would be: - When the GEE model includes covariates beyond treatment and you want covariate-adjusted marginal effects - When you want effects on a different scale than the model’s link function</p>
<p>If the GEE model is <code>GEE(Y_it ~ Trt + Time + Trt:Time + Covariates, family=binomial, corstr="unstructured")</code>, the marginal treatment effects at each timepoint can be obtained either: 1. Directly from the model coefficients (conditional on covariates staying at reference) 2. Via g-computation/standardisation (averaged over the covariate distribution) — <strong>this is what beeca does</strong></p>
<p>So the g-computation step remains relevant and valuable.</p>
</div>
<div class="section level3">
<h3 id="id_23-variance-estimation-the-critical-challenge">2.3 Variance estimation: the critical challenge<a class="anchor" aria-label="anchor" href="#id_23-variance-estimation-the-critical-challenge"></a></h3>
<p>This is where the biggest methodological departure occurs:</p>
<p><strong>Current (GLM)</strong>: - Ge method: <code>D × vcovHC(glm) × D'</code> — the sandwich is for independent observations - Ye method: variance decomposition using per-subject residuals — also assumes independence</p>
<p><strong>Required (GEE)</strong>: - The “meat” of the sandwich must account for <strong>within-cluster (within-subject) correlation</strong> - GEE sandwich: <code>B⁻¹ × M × B⁻¹</code> where M = Σᵢ Dᵢ’ Vᵢ⁻¹ (Yᵢ - μᵢ)(Yᵢ - μᵢ)’ Vᵢ⁻¹ Dᵢ, summed over <strong>clusters</strong> not individual observations - The Mancl-DeRouen (2001) correction replaces raw residuals with leverage-corrected residuals: <code>eᵢ* = (I - Hᵢ)⁻¹ eᵢ</code></p>
<p><strong>Neither the Ge nor the Ye variance method directly applies to the GEE case.</strong> Both assume the model is a single-observation-per-subject GLM. The extension would need to:</p>
<ol style="list-style-type: decimal"><li>Use the GEE’s own cluster-robust sandwich variance for the parameter estimates</li>
<li>Propagate this through the delta method for g-computation (analogous to what Ge does, but with the GEE sandwich instead of <code>vcovHC()</code>)</li>
<li>Or develop a Ye-style variance decomposition that respects the clustered structure</li>
</ol></div>
<div class="section level3">
<h3 id="id_24-counterfactual-predictions-in-longitudinal-setting">2.4 Counterfactual predictions in longitudinal setting<a class="anchor" aria-label="anchor" href="#id_24-counterfactual-predictions-in-longitudinal-setting"></a></h3>
<p>The current <code><a href="reference/predict_counterfactuals.html">predict_counterfactuals()</a></code> creates an N × K matrix (N subjects, K treatment levels). In a longitudinal setting, you would need:</p>
<ul><li>An (N × T) × K matrix (N subjects × T timepoints × K treatments), or</li>
<li>Marginal means at each timepoint separately</li>
<li>The “average” step would need to average within timepoint-treatment cells, not just treatment cells</li>
</ul></div>
<div class="section level3">
<h3 id="id_25-the-mancl-derouen-estimator">2.5 The Mancl-DeRouen estimator<a class="anchor" aria-label="anchor" href="#id_25-the-mancl-derouen-estimator"></a></h3>
<p>The Mancl-DeRouen (M-dR) corrected sandwich estimator is a small-sample bias correction for the GEE sandwich variance. It inflates residuals by the inverse of <code>(I - H_i)</code> where <code>H_i</code> is the leverage matrix for cluster i.</p>
<ul><li>This is analogous to HC3 in the single-observation case (HC3 uses <code>1/(1-h_ii)²</code> per observation)</li>
<li>beeca already supports HC0-HC5 for single-observation GLMs via <code><a href="https://sandwich.R-Forge.R-project.org/reference/vcovHC.html" class="external-link">sandwich::vcovHC()</a></code>
</li>
<li>For GEE, <code><a href="https://sandwich.R-Forge.R-project.org/reference/vcovHC.html" class="external-link">sandwich::vcovHC()</a></code> does not apply — you need the clustered version</li>
<li>The <code>glmtoolbox</code> package provides M-dR directly; <code>geesbin</code> does as well</li>
</ul></div>
<div class="section level3">
<h3 id="id_26-firth-like-penalised-gee">2.6 Firth-like penalised GEE<a class="anchor" aria-label="anchor" href="#id_26-firth-like-penalised-gee"></a></h3>
<p>Firth penalisation addresses separation/quasi-separation in logistic regression — events where ML estimation fails because a covariate perfectly predicts the outcome. In GEE:</p>
<ul><li>Standard GEE can suffer from the same convergence issues with rare events</li>
<li>Firth-type penalisation adds a Jeffreys-prior-like penalty to the GEE estimating equations</li>
<li>The <code>geesbin</code> package implements this</li>
<li>beeca would need to accept the fitted penalised GEE object and use its predictions/variance</li>
</ul><hr></div>
</div>
<div class="section level2">
<h2 id="id_3-technical-implications-what-would-need-to-change">3. Technical Implications: What Would Need to Change<a class="anchor" aria-label="anchor" href="#id_3-technical-implications-what-would-need-to-change"></a></h2>
<div class="section level3">
<h3 id="id_31-input-validation-sanitizer">3.1 Input validation (<code>sanitize.R</code>)<a class="anchor" aria-label="anchor" href="#id_31-input-validation-sanitizer"></a></h3>
<table class="table"><colgroup><col width="50%"><col width="50%"></colgroup><thead><tr class="header"><th>Current</th>
<th>Required change</th>
</tr></thead><tbody><tr class="odd"><td>Only accepts <code>glm</code> class</td>
<td>Add <code><a href="reference/sanitize_model.glmgee.html">sanitize_model.glmgee()</a></code> and/or <code><a href="reference/sanitize_model.geeglm.html">sanitize_model.geeglm()</a></code> S3 methods</td>
</tr><tr class="even"><td>Checks <code>$family$family == "binomial"</code>
</td>
<td>GEE objects store family differently; <code>glmgee</code> uses <code>$family</code> but structure differs</td>
</tr><tr class="odd"><td>Checks <code>$converged</code>
</td>
<td>GEE convergence flag location differs</td>
</tr><tr class="even"><td>Checks <code>$qr$rank</code>
</td>
<td>GEE objects may not have QR decomposition</td>
</tr><tr class="odd"><td>Checks response is 0/1</td>
<td>Would need to also handle ordinal responses if extending to ordinal GEE</td>
</tr><tr class="even"><td>No cluster ID concept</td>
<td>Need to validate and track cluster/subject identifier</td>
</tr><tr class="odd"><td>No timepoint concept</td>
<td>Need to validate and track visit/timepoint variable</td>
</tr></tbody></table></div>
<div class="section level3">
<h3 id="id_32-counterfactual-predictions-predict_counterfactualsr">3.2 Counterfactual predictions (<code>predict_counterfactuals.R</code>)<a class="anchor" aria-label="anchor" href="#id_32-counterfactual-predictions-predict_counterfactualsr"></a></h3>
<table class="table"><colgroup><col width="50%"><col width="50%"></colgroup><thead><tr class="header"><th>Current</th>
<th>Required change</th>
</tr></thead><tbody><tr class="odd"><td>Uses <code>stats::predict(object, newdata, type="response")</code>
</td>
<td>GEE predict methods differ; <code><a href="https://rdrr.io/pkg/glmtoolbox/man/predict.glmgee.html" class="external-link">glmtoolbox::predict.glmgee()</a></code> exists but API differs</td>
</tr><tr class="even"><td>Creates N × K tibble</td>
<td>Need N×T × K structure, or predict at each timepoint separately</td>
</tr><tr class="odd"><td>Single response per subject</td>
<td>Need to handle multiple responses per subject</td>
</tr><tr class="even"><td>No time dimension</td>
<td>Counterfactuals need to be timepoint-specific</td>
</tr></tbody></table></div>
<div class="section level3">
<h3 id="id_33-averaging-average_predictionsr">3.3 Averaging (<code>average_predictions.R</code>)<a class="anchor" aria-label="anchor" href="#id_33-averaging-average_predictionsr"></a></h3>
<table class="table"><colgroup><col width="50%"><col width="50%"></colgroup><thead><tr class="header"><th>Current</th>
<th>Required change</th>
</tr></thead><tbody><tr class="odd"><td>Simple <code><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans()</a></code> over all subjects</td>
<td>Need to average within timepoint-treatment cells</td>
</tr><tr class="even"><td>Returns K-length vector</td>
<td>Returns K × T matrix of marginal means</td>
</tr></tbody></table></div>
<div class="section level3">
<h3 id="id_34-variance-estimation-estimate_varcovr">3.4 Variance estimation (<code>estimate_varcov.R</code>)<a class="anchor" aria-label="anchor" href="#id_34-variance-estimation-estimate_varcovr"></a></h3>
<p>This is the <strong>most substantial</strong> change required.</p>
<p><strong>Ge method path</strong>: - Currently: <code>D × sandwich::vcovHC(glm) × D'</code> - Required: <code>D × vcov_gee_clustered(gee_model) × D'</code> - Where <code>vcov_gee_clustered</code> is the GEE sandwich (or M-dR corrected) variance of parameters - The <code>D</code> matrix (gradient of g-computation w.r.t. parameters) would need to be computed per timepoint - The result would be a (K×T) × (K×T) variance-covariance matrix spanning all treatment-timepoint combinations</p>
<p><strong>Ye method path</strong>: - The Ye et al. variance decomposition was derived specifically for independent binary outcomes - It is <strong>not directly applicable</strong> to longitudinal data - A new derivation would be needed, or this method would not be supported for GEE</p>
<p><strong>Practical approach</strong>: Use the GEE model’s own cluster-robust variance and propagate through the delta method. This is methodologically sound and sidesteps the need to re-derive Ye’s decomposition.</p>
</div>
<div class="section level3">
<h3 id="id_35-contrasts-apply_contrastr">3.5 Contrasts (<code>apply_contrast.R</code>)<a class="anchor" aria-label="anchor" href="#id_35-contrasts-apply_contrastr"></a></h3>
<table class="table"><colgroup><col width="50%"><col width="50%"></colgroup><thead><tr class="header"><th>Current</th>
<th>Required change</th>
</tr></thead><tbody><tr class="odd"><td>K × K contrast matrix</td>
<td>Need (K×T) × (K×T) structure, or contrasts computed per timepoint</td>
</tr><tr class="even"><td>Single set of contrasts</td>
<td>Multiple contrasts: one per timepoint, or pooled across timepoints</td>
</tr><tr class="odd"><td>No multiplicity adjustment</td>
<td>Need MVT-based p-value adjustment or gatekeeping</td>
</tr><tr class="even"><td>Delta method on K-dim means</td>
<td>Delta method on K×T-dim means</td>
</tr></tbody></table></div>
<div class="section level3">
<h3 id="id_36-output--reporting-get_marginal_effectr-tidyr-summaryr">3.6 Output / reporting (<code>get_marginal_effect.R</code>, <code>tidy.R</code>, <code>summary.R</code>)<a class="anchor" aria-label="anchor" href="#id_36-output--reporting-get_marginal_effectr-tidyr-summaryr"></a></h3>
<table class="table"><colgroup><col width="50%"><col width="50%"></colgroup><thead><tr class="header"><th>Current</th>
<th>Required change</th>
</tr></thead><tbody><tr class="odd"><td>ARD format assumes single timepoint</td>
<td>Need AVISIT/timepoint dimension in ARD output</td>
</tr><tr class="even"><td>
<code>marginal_results</code> has TRTVAR/TRTVAL/PARAM/STAT</td>
<td>Add visit/timepoint column</td>
</tr><tr class="odd"><td>Forest plot for single timepoint</td>
<td>Multi-timepoint forest plot</td>
</tr><tr class="even"><td>
<code><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy()</a></code> returns one row per contrast</td>
<td>Returns rows per contrast × timepoint</td>
</tr></tbody></table></div>
<div class="section level3">
<h3 id="id_37-new-dependencies">3.7 New dependencies<a class="anchor" aria-label="anchor" href="#id_37-new-dependencies"></a></h3>
<table class="table"><colgroup><col width="33%"><col width="33%"><col width="33%"></colgroup><thead><tr class="header"><th>Package</th>
<th>Purpose</th>
<th>Status</th>
</tr></thead><tbody><tr class="odd"><td><code>glmtoolbox</code></td>
<td>GEE fitting, M-dR variance</td>
<td>Would move from nothing to Suggests or Imports</td>
</tr><tr class="even"><td><code>geepack</code></td>
<td>Alternative GEE fitting</td>
<td>Suggests</td>
</tr><tr class="odd"><td><code>geesbin</code></td>
<td>Firth-penalised GEE</td>
<td>Suggests</td>
</tr><tr class="even"><td><code>mvtnorm</code></td>
<td>MVT-based multiplicity adjustment</td>
<td>New dependency (Imports or Suggests)</td>
</tr><tr class="odd"><td><code>emmeans</code></td>
<td>Marginal means integration</td>
<td>Suggests</td>
</tr></tbody></table><hr></div>
</div>
<div class="section level2">
<h2 id="id_4-pros-and-cons">4. Pros and Cons<a class="anchor" aria-label="anchor" href="#id_4-pros-and-cons"></a></h2>
<div class="section level3">
<h3 id="id_41-pros-of-extending-beeca">4.1 Pros of extending beeca<a class="anchor" aria-label="anchor" href="#id_41-pros-of-extending-beeca"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>Fills a genuine gap</strong>: There is no R package that combines g-computation-based covariate adjustment with GEE for longitudinal binary endpoints in a clinical-trial-focused workflow</li>
<li>
<strong>Natural extension of the estimand framework</strong>: The ICH E9(R1) estimand framework (which beeca’s documentation references) explicitly applies to longitudinal settings</li>
<li>
<strong>Regulatory relevance</strong>: FDA guidance on covariate adjustment applies to longitudinal trials too; having robust tools strengthens submissions</li>
<li>
<strong>Reuse of existing infrastructure</strong>: The g-computation pipeline (predict counterfactuals → average → contrast) is conceptually identical; only the variance step fundamentally changes</li>
<li>
<strong>M-dR estimator demand</strong>: The issue author highlights real regulatory pushback on standard sandwich in small samples — providing M-dR support meets a practical need</li>
<li>
<strong>Package differentiation</strong>: beeca would become unique in combining covariate-adjusted marginal effects + GEE + small-sample corrections + clinical trial reporting (ARD/CDISC format)</li>
</ol></div>
<div class="section level3">
<h3 id="id_42-cons--risks">4.2 Cons / Risks<a class="anchor" aria-label="anchor" href="#id_42-cons--risks"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>Scope creep</strong>: beeca is currently a focused, well-scoped package (~4500 lines). Adding longitudinal support could double or triple complexity</li>
<li>
<strong>Methodological uncertainty</strong>: The Ye variance decomposition has no published extension to GEE — only the Ge/delta-method approach would transfer. This means half the current methodology doesn’t extend</li>
<li>
<strong>Dependency burden</strong>: Adding <code>glmtoolbox</code>, <code>geesbin</code>, <code>mvtnorm</code> as dependencies increases maintenance risk and GxP validation burden</li>
<li>
<strong>Testing complexity</strong>: Longitudinal data has many more edge cases (unbalanced visits, dropout patterns, monotone missingness, time-varying covariates)</li>
<li>
<strong>Package identity</strong>: “Binary Endpoint Estimation with Covariate Adjustment” — the name and scope are tied to the single-binary-endpoint case. Longitudinal binary data is a different use case</li>
<li>
<strong>Validation burden</strong>: For pharma use, every new method pathway needs extensive validation against known results (SAS, other validated tools). There are fewer published benchmarks for g-computation + GEE</li>
<li>
<strong>Competing approaches</strong>: Some would argue that for longitudinal binary data with covariate adjustment, MMRM-like approaches (treating each visit as a separate endpoint in a multivariate model) are more established than GEE</li>
<li>
<strong>Ordinal extension</strong>: The issue mentions ordinal endpoints — this is an even larger departure from binary logistic regression</li>
</ol></div>
<div class="section level3">
<h3 id="id_43-middle-ground-options">4.3 Middle-ground options<a class="anchor" aria-label="anchor" href="#id_43-middle-ground-options"></a></h3>
<p>Rather than full longitudinal GEE support, consider:</p>
<ol style="list-style-type: decimal"><li><p><strong>Accept GEE objects but only for single-timepoint analysis</strong>: Allow users to fit a GEE (which handles clustering from other sources, e.g., site-level clustering) and extract marginal effects at a single timepoint. This is a much smaller change.</p></li>
<li><p><strong>Multi-endpoint wrapper</strong>: Keep the per-endpoint analysis as-is, but add a higher-level function that runs beeca independently at each timepoint and then applies MVT adjustment to the collection of p-values. This requires no changes to the core pipeline.</p></li>
<li><p><strong>Point to RobinCar</strong>: The <code>RobinCar</code> package (already in Suggests) has been developing longitudinal extensions. beeca could focus on being the clinical-trial-reporting layer on top of RobinCar’s longitudinal capabilities.</p></li>
</ol><hr></div>
</div>
<div class="section level2">
<h2 id="id_5-specific-technical-concerns">5. Specific Technical Concerns<a class="anchor" aria-label="anchor" href="#id_5-specific-technical-concerns"></a></h2>
<div class="section level3">
<h3 id="id_51-the-sandwichvcovhc-dependency">5.1 The <code>sandwich::vcovHC()</code> dependency<a class="anchor" aria-label="anchor" href="#id_51-the-sandwichvcovhc-dependency"></a></h3>
<p>beeca’s Ge method relies entirely on <code><a href="https://sandwich.R-Forge.R-project.org/reference/vcovHC.html" class="external-link">sandwich::vcovHC()</a></code> for the parameter variance matrix. This function is designed for <code>lm</code>/<code>glm</code> objects with independent observations. For GEE:</p>
<ul><li>
<code><a href="https://sandwich.R-Forge.R-project.org/reference/vcovCL.html" class="external-link">sandwich::vcovCL()</a></code> (cluster-robust) could be used if the GEE object can be coerced, but this doesn’t account for the working correlation</li>
<li>The GEE model’s own <code><a href="https://rdrr.io/r/stats/vcov.html" class="external-link">vcov()</a></code> method already provides the robust sandwich</li>
<li>For M-dR, you need the GEE package’s own implementation (glmtoolbox provides this)</li>
<li>
<strong>Bottom line</strong>: The <code>sandwich</code> package dependency would become less central; the GEE package itself would provide the variance</li>
</ul></div>
<div class="section level3">
<h3 id="id_52-the-get_data-assumption">5.2 The <code>.get_data()</code> assumption<a class="anchor" aria-label="anchor" href="#id_52-the-get_data-assumption"></a></h3>
<p>Currently <code>.get_data()</code> returns <code>model$model</code> (the model frame from <code>glm</code>). GEE objects may store data differently: - <code><a href="https://rdrr.io/pkg/glmtoolbox/man/glmgee.html" class="external-link">glmtoolbox::glmgee</a></code> stores data in <code>$model</code> (similar to glm) - <code><a href="https://rdrr.io/pkg/geepack/man/geeglm.html" class="external-link">geepack::geeglm</a></code> stores data in <code>$data</code> or <code>$model</code> - Need to verify data retrieval works correctly with repeated-measures data structure</p>
</div>
<div class="section level3">
<h3 id="id_53-the-predict-step">5.3 The <code>predict()</code> step<a class="anchor" aria-label="anchor" href="#id_53-the-predict-step"></a></h3>
<p>GEE predict methods may not support <code>newdata</code> arguments in the same way as <code><a href="https://rdrr.io/r/stats/predict.glm.html" class="external-link">stats::predict.glm()</a></code>. This needs careful testing. If <code>predict.glmgee()</code> doesn’t support arbitrary newdata, the counterfactual prediction step breaks down entirely.</p>
</div>
<div class="section level3">
<h3 id="id_54-treatment-by-time-interactions">5.4 Treatment-by-time interactions<a class="anchor" aria-label="anchor" href="#id_54-treatment-by-time-interactions"></a></h3>
<p>For longitudinal analysis, the model almost always includes <code>Trt × Time</code> interaction. beeca currently <strong>blocks</strong> treatment interactions (<code><a href="reference/sanitize_model.glm.html">sanitize_model.glm()</a></code> lines 50-55). This check would need to be relaxed for GEE models to allow <code>Trt × Visit</code> interactions (which are essential for estimating timepoint-specific effects).</p>
<hr></div>
</div>
<div class="section level2">
<h2 id="id_6-recommended-path-forward">6. Recommended Path Forward<a class="anchor" aria-label="anchor" href="#id_6-recommended-path-forward"></a></h2>
<div class="section level3">
<h3 id="phase-0-scoping-no-code-changes">Phase 0: Scoping (no code changes)<a class="anchor" aria-label="anchor" href="#phase-0-scoping-no-code-changes"></a></h3>
<ul><li>Decide whether longitudinal support belongs in beeca or a companion package (e.g., <code>beecal</code> for “longitudinal”)</li>
<li>Survey the regulatory landscape: are sponsors actually using g-computation + GEE, or is GEE direct estimation sufficient?</li>
<li>Check whether RobinCar’s longitudinal features cover this need</li>
</ul></div>
<div class="section level3">
<h3 id="phase-1-accept-gee-objects-for-cross-sectional-analysis">Phase 1: Accept GEE objects for cross-sectional analysis<a class="anchor" aria-label="anchor" href="#phase-1-accept-gee-objects-for-cross-sectional-analysis"></a></h3>
<ul><li>Add <code><a href="reference/sanitize_model.glmgee.html">sanitize_model.glmgee()</a></code> S3 method</li>
<li>Allow GEE-fitted models to flow through the existing pipeline</li>
<li>Use GEE’s own vcov (including M-dR) instead of <code><a href="https://sandwich.R-Forge.R-project.org/reference/vcovHC.html" class="external-link">sandwich::vcovHC()</a></code>
</li>
<li>No multi-timepoint support yet — just robustness to clustered data</li>
<li>Smallest change, biggest immediate value</li>
</ul></div>
<div class="section level3">
<h3 id="phase-2-multi-timepoint-marginal-effects">Phase 2: Multi-timepoint marginal effects<a class="anchor" aria-label="anchor" href="#phase-2-multi-timepoint-marginal-effects"></a></h3>
<ul><li>Extend counterfactual predictions to be timepoint-specific</li>
<li>Extend averaging to produce means per treatment × timepoint</li>
<li>Extend variance to produce joint (treatment × timepoint) variance-covariance</li>
<li>Only Ge-style delta method (not Ye decomposition)</li>
</ul></div>
<div class="section level3">
<h3 id="phase-3-multiplicity-adjustment">Phase 3: Multiplicity adjustment<a class="anchor" aria-label="anchor" href="#phase-3-multiplicity-adjustment"></a></h3>
<ul><li>Add MVT-based adjustment using the joint variance-covariance matrix</li>
<li>Add gatekeeping procedures</li>
<li>Potentially via <code><a href="https://rdrr.io/pkg/mvtnorm/man/pmvt.html" class="external-link">mvtnorm::pmvt()</a></code> for the multivariate t distribution</li>
</ul></div>
<div class="section level3">
<h3 id="phase-4-firth-penalised-gee-and-ordinal">Phase 4: Firth-penalised GEE and ordinal<a class="anchor" aria-label="anchor" href="#phase-4-firth-penalised-gee-and-ordinal"></a></h3>
<ul><li>Accept <code>geesbin</code> objects</li>
<li>Consider ordinal GEE (proportional odds GEE) — major additional work</li>
</ul><hr></div>
</div>
<div class="section level2">
<h2 id="id_7-summary-table">7. Summary Table<a class="anchor" aria-label="anchor" href="#id_7-summary-table"></a></h2>
<table class="table"><colgroup><col width="25%"><col width="25%"><col width="25%"><col width="25%"></colgroup><thead><tr class="header"><th>Feature requested</th>
<th>Difficulty</th>
<th>Value</th>
<th>Recommendation</th>
</tr></thead><tbody><tr class="odd"><td>Accept GEE model objects</td>
<td>Medium</td>
<td>High</td>
<td>Phase 1 — do this</td>
</tr><tr class="even"><td>Mancl-DeRouen variance</td>
<td>Low (use GEE package’s own)</td>
<td>High</td>
<td>Phase 1 — comes naturally</td>
</tr><tr class="odd"><td>Multi-timepoint g-computation</td>
<td>High</td>
<td>High</td>
<td>Phase 2 — significant new code</td>
</tr><tr class="even"><td>MVT multiplicity adjustment</td>
<td>Medium</td>
<td>Medium</td>
<td>Phase 3 — mostly wrapper code</td>
</tr><tr class="odd"><td>Firth-penalised GEE</td>
<td>Medium</td>
<td>Medium</td>
<td>Phase 4 — accept the object</td>
</tr><tr class="even"><td>Ordinal endpoints</td>
<td>Very High</td>
<td>Medium</td>
<td>Separate consideration — changes the entire pipeline</td>
</tr><tr class="odd"><td>Integration with emmeans</td>
<td>Medium</td>
<td>Medium</td>
<td>Deferred — requires S3 method registration</td>
</tr><tr class="even"><td>Integration with mice</td>
<td>Low</td>
<td>Low</td>
<td>Already possible if user fits GEE on imputed data</td>
</tr></tbody></table></div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Alex Przybylski, Mark Baillie, Craig Wang, Dominic Magirr.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

